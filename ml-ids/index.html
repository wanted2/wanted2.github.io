<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<link rel="icon" href="https://wanted2.github.io/assets/images/favicon.ico">

<title>Machine Learning for Network Intrusion Detection: From Local to Production | AiFi</title>

 
    
        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-2CDTCF0EP6" crossorigin="anonymous"></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());

            gtag('config', 'G-2CDTCF0EP6');
        </script>
    


<!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Machine Learning for Network Intrusion Detection: From Local to Production | AiFi</title>
<meta name="generator" content="Jekyll v4.2.1" />
<meta property="og:title" content="Machine Learning for Network Intrusion Detection: From Local to Production" />
<meta name="author" content="tuan" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Network Intrusion Detection System Network intrusion detection system (NIDS) is an independent platform that examines network traffic patterns to identify intrusions for an entire network. It needs to be placed at a choke point where all traffic traverses. A good location for this is in the DMZ. An IDS is reactive in nature: it only monitors and sends alerts to a group of specific people like administrators. The above figure shows a common NIDS architecture, where a DMZ is placed in between external firewall and internal firewall (to an internal network). Here, in the DMZ, a NIDS can be set up to monitor the traffic of the whole corporation and identify the anomalies." />
<meta property="og:description" content="Network Intrusion Detection System Network intrusion detection system (NIDS) is an independent platform that examines network traffic patterns to identify intrusions for an entire network. It needs to be placed at a choke point where all traffic traverses. A good location for this is in the DMZ. An IDS is reactive in nature: it only monitors and sends alerts to a group of specific people like administrators. The above figure shows a common NIDS architecture, where a DMZ is placed in between external firewall and internal firewall (to an internal network). Here, in the DMZ, a NIDS can be set up to monitor the traffic of the whole corporation and identify the anomalies." />
<meta property="og:site_name" content="AiFi" />
<meta property="og:image" content="https://daga88.bet/wp-content/uploads/2021/01/ap-tr.jpg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-01-29T00:00:00+09:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://daga88.bet/wp-content/uploads/2021/01/ap-tr.jpg" />
<meta property="twitter:title" content="Machine Learning for Network Intrusion Detection: From Local to Production" />
<script type="application/ld+json">
{"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"/https://wanted2.github.io/assets/images/favicon.ico"},"name":"tuan"},"description":"Network Intrusion Detection System Network intrusion detection system (NIDS) is an independent platform that examines network traffic patterns to identify intrusions for an entire network. It needs to be placed at a choke point where all traffic traverses. A good location for this is in the DMZ. An IDS is reactive in nature: it only monitors and sends alerts to a group of specific people like administrators. The above figure shows a common NIDS architecture, where a DMZ is placed in between external firewall and internal firewall (to an internal network). Here, in the DMZ, a NIDS can be set up to monitor the traffic of the whole corporation and identify the anomalies.","image":"https://daga88.bet/wp-content/uploads/2021/01/ap-tr.jpg","headline":"Machine Learning for Network Intrusion Detection: From Local to Production","dateModified":"2022-01-29T00:00:00+09:00","datePublished":"2022-01-29T00:00:00+09:00","url":"/https://wanted2.github.io/ml-ids/","author":{"@type":"Person","name":"tuan"},"mainEntityOfPage":{"@type":"WebPage","@id":"/https://wanted2.github.io/ml-ids/"},"@type":"BlogPosting","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    
<link href="https://wanted2.github.io/assets/css/screen.css" rel="stylesheet">

<link href="https://wanted2.github.io/assets/css/main.css" rel="stylesheet">

<script src="https://wanted2.github.io/assets/js/jquery.min.js"></script>
<script src="https://kit.fontawesome.com/d0b91d895e.js" crossorigin="anonymous"></script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        processEscapes: true
    }
    });
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript" crossorigin="anonymous"></script>
<script src="https://d3js.org/d3.v4.js" crossorigin="anonymous"></script>
<!-- <script src="https://bl.ocks.org/mbostock/raw/4061502/0a200ddf998aa75dfdb1ff32e16b680a15e5cb01/box.js" crossorigin="anonymous"></script> -->
</head>


<body class="layout-post">
	<!-- defer loading of font and font awesome -->
	<noscript id="deferred-styles">
		<link href="https://fonts.googleapis.com/css?family=Righteous%7CMerriweather:300,300i,400,400i,700,700i" rel="stylesheet">
		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
	</noscript>


<!-- Begin Menu Navigation
================================================== -->
<nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top mediumnavigation nav-down">

    <div class="container pr-0">

    <!-- Begin Logo -->
    <a class="navbar-brand" href="https://wanted2.github.io/">
    <img src="https://wanted2.github.io/assets/images/favicon.ico" alt="AiFi">
    </a>
    <!-- End Logo -->

    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarMediumish" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarMediumish">

        <!-- Begin Menu -->

            <ul class="navbar-nav ml-auto">

                
                <li class="nav-item">
                
                <a class="nav-link" href="https://wanted2.github.io/">Blog</a>
                </li>

                <li class="nav-item">
                <a class="nav-link" href="https://wanted2.github.io/about">About</a>
                </li>

                <li class="nav-item">
                <a class="nav-link" href="https://wanted2.github.io/projects">Projects</a>
                </li>

                <!-- <li class="nav-item">
                <a target="_blank" class="nav-link" href="https://bootstrapstarter.com/bootstrap-templates/template-mediumish-bootstrap-jekyll/"> Docs</a>
                </li>

                <li class="nav-item">
                <a target="_blank" class="nav-link" href="https://www.wowthemes.net/themes/mediumish-wordpress/"><i class="fab fa-wordpress-simple"></i> WP Version</a>
                </li>

                <li class="nav-item">
                <a target="_blank" class="nav-link" href="https://www.wowthemes.net/themes/mediumish-ghost/"><i class="fab fa-snapchat-ghost"></i> Ghost Version</a>
                </li>

                <li class="nav-item">
                <a target="_blank" class="nav-link" href="https://github.com/wowthemesnet/mediumish-theme-jekyll"><i class="fab fa-github"></i> Fork on Github</a>
                </li> -->

                <!-- <script src="https://wanted2.github.io/assets/js/lunr.js"></script>


<style>
    .lunrsearchresult .title {color: #d9230f;}
    .lunrsearchresult .url {color: silver;}
    .lunrsearchresult a {display: block; color: #777;}
    .lunrsearchresult a:hover, .lunrsearchresult a:focus {text-decoration: none;}
    .lunrsearchresult a:hover .title {text-decoration: underline;}
</style>


<form class="bd-search" onSubmit="return lunr_search(document.getElementById('lunrsearch').value);">
    <input type="text" class="form-control text-small launch-modal-search" id="lunrsearch" name="q" maxlength="255" value="" placeholder="Type and enter..."/>
</form>

<div id="lunrsearchresults">
    <ul></ul>
</div>

<script src="https://wanted2.github.io/assets/js/lunrsearchengine.js"></script> -->

            </ul>

        <!-- End Menu -->

    </div>

    </div>
</nav>
<!-- End Navigation
================================================== -->

<div class="site-content">

<div class="container">

<!-- Site Title
================================================== -->
<div class="mainheading">
    <h1 class="sitetitle">AiFi</h1>
    <p class="lead">
        An AI Engineer's blog
    </p>
</div>

<!-- Content
================================================== -->
<div class="main-content">
    <!-- Begin Article
================================================== -->
<div class="container">
    <div class="row">

        <!-- Post Share -->
        <div class="col-md-2 pl-0">
            <div class="share sticky-top sticky-top-offset">
    <p>
        Share
    </p>
    <ul>
        <li class="ml-1 mr-1">
            <a target="_blank" href="https://twitter.com/intent/tweet?text=Machine Learning for Network Intrusion Detection: From Local to Production&url=https://wanted2.github.io/ml-ids/" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                <i class="fab fa-twitter"></i>
            </a>
        </li>

        <li class="ml-1 mr-1">
            <a target="_blank" href="https://facebook.com/sharer.php?u=https://wanted2.github.io/ml-ids/" onclick="window.open(this.href, 'facebook-share', 'width=550,height=435');return false;">
                <i class="fab fa-facebook-f"></i>
            </a>
        </li>

        <li class="ml-1 mr-1">
            <a target="_blank" href="https://www.linkedin.com/shareArticle?mini=true&url=https://wanted2.github.io/ml-ids/" onclick="window.open(this.href, 'width=550,height=435');return false;">
                <i class="fab fa-linkedin-in"></i>
            </a>
        </li>

        <li class="ml-1 mr-1">
            <a target="_blank" href="mailto:?subject=Machine Learning for Network Intrusion Detection: From Local to Production&body=https://wanted2.github.io/ml-ids/" onclick="window.open(this.href, 'width=550,height=435');return false;">
                <i class="fas fa-envelope"></i>
            </a>
        </li>

    </ul>
    
    <div class="sep">
    </div>
    <ul>
        <li>
        <a class="small smoothscroll" href="#disqus_thread"></a>
        </li>
    </ul>
    
</div>

        </div>

        <!-- Post -->
        

        <div class="col-md-9 flex-first flex-md-unordered">
            <div class="mainheading">

                <!-- Author Box -->
                
                <div class="row post-top-meta">
                    <div class="col-xs-12 col-md-2 col-lg-2 text-left mb-4 mb-md-0">
                        
                        <img class="author-thumb" src="https://wanted2.github.io/assets/images/favicon.png" alt="AiFi">
                        
                    </div>
                    <div class="col-xs-12 col-md-10 col-lg-10 text-right">
                        <a target="_blank" class="link-dark" href="">AiFi</a>
                        <!-- <a target="_blank" href="" class="btn follow">Follow</a> -->
                        <!-- LikeBtn.com BEGIN -->
                        <span class="likebtn-wrapper" 
                            data-site_id="61cfccd36fd08b2d68c1929e"
                            data-theme="custom" 
                            data-icon_l_url="/assets/images/OK_EM.png" 
                            data-icon_l_url_v="/assets/images/OK_EM_clicked.png" 
                            data-identifier="/ml-ids/" 
                            data-show_like_label="false" 
                            data-like_enabled="false" 
                            data-dislike_enabled="false" 
                            data-icon_dislike_show="false" 
                            data-voting_cancelable="false" 
                            data-counter_show="true"
                            data-counter_frmt="comma"></span>
                        <script>(function(d,e,s){if(d.getElementById("likebtn_wjs"))return;a=d.createElement(e);m=d.getElementsByTagName(e)[0];a.async=1;a.id="likebtn_wjs";a.src=s;m.parentNode.insertBefore(a, m)})(document,"script","//w.likebtn.com/js/w/widget.js");</script>
                        <!-- LikeBtn.com END -->
                        <span class="author-description"></span>
                    </div>
                </div>
                

                <!-- Post Title -->
                <h1 class="posttitle">Machine Learning for Network Intrusion Detection: From Local to Production</h1>

            </div>

            <!-- Adsense if enabled from _config.yml (change your pub id and slot) -->
            
            <!-- End Adsense -->

            <!-- Post Featured Image -->
            

            
            <img class="featured-image img-fluid lazyimg" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAMAAAACCAQAAAA3fa6RAAAADklEQVR42mNkAANGCAUAACMAA2w/AMgAAAAASUVORK5CYII=" data-src="https://daga88.bet/wp-content/uploads/2021/01/ap-tr.jpg" alt="Machine Learning for Network Intrusion Detection: From Local to Production">
            

            
            <!-- End Featured Image -->

            <!-- Post Content -->
            <div class="article-post">
                <!-- Toc if any -->
                
                    
                    <div class="toc mt-4 mb-4 lead">
                        <h3 class="font-weight-bold">Summary</h3>
                        <ul>
  <li><a href="#network-intrusion-detection-system">Network Intrusion Detection System</a></li>
  <li><a href="#machine-learning-at-scale-some-solutions-in-aws">Machine Learning at scale: some solutions in AWS</a>
    <ul>
      <li><a href="#overview">Overview</a></li>
      <li><a href="#challenges-in-nids-operations">Challenges in NIDS operations</a></li>
    </ul>
  </li>
  <li><a href="#machine-learning-at-local">Machine Learning at local</a>
    <ul>
      <li><a href="#a-kaggle-synthetic-dataset">A Kaggle synthetic dataset</a>
        <ul>
          <li><a href="#explorative-analysis">Explorative analysis</a></li>
          <li><a href="#play-with-some-machine-learners">Play with some machine learners</a>
            <ul>
              <li><a href="#training-and-validation">Training and validation</a></li>
              <li><a href="#results-of-auto-encoder">Results of Auto-Encoder</a></li>
              <li><a href="#results-of-random-forest">Results of Random Forest</a></li>
            </ul>
          </li>
        </ul>
      </li>
      <li><a href="#some-methods-for-machine-learning-based-ids">Some methods for Machine Learning based IDS</a></li>
    </ul>
  </li>
  <li><a href="#conclusion">Conclusion</a></li>
</ul>
                    </div>
                
                <!-- End Toc -->
                <h1 id="network-intrusion-detection-system">Network Intrusion Detection System</h1>

<p><img src="https://www.researchgate.net/profile/Simon-Enoch/publication/319637372/figure/fig1/AS:543679434510336@1506634686111/Configuration-of-the-enterprise-network.png" style="float: left; margin: 10px; width: 50%;" /></p>

<blockquote>
  <p><strong>Network intrusion detection system (NIDS)</strong> is an independent platform that examines network traffic patterns to identify intrusions for an entire network. It needs to be placed at a choke point where all traffic traverses. A good location for this is in the DMZ.</p>
</blockquote>

<p>An IDS is <em>reactive</em> in nature: it only monitors and sends alerts to a group of specific people like administrators.
The above figure shows a common NIDS architecture, where a DMZ is placed in between <em>external firewall</em> and <em>internal firewall (to an internal network)</em>.
Here, in the DMZ, a NIDS can be set up to monitor the traffic of the whole corporation and identify the anomalies.
<!--more--></p>

<p><img src="https://www.researchgate.net/profile/Vivek-Singh-70/publication/328572055/figure/fig1/AS:686824250945536@1540763070945/Major-Components-of-Snort-IDS-and-Bro-IDS.ppm" style="float: right; margin: 10px; width: 50%;" />
A NIDS can have the following architecture:</p>

<ul>
  <li>A <strong>streaming engine</strong> which ingests packet stream into the NIDS</li>
  <li>A <strong>package decoder</strong> which turns packet content into visibility</li>
  <li>A <strong>detection engine</strong> which identify intrusions</li>
  <li>A <strong>policy engine</strong> which decide and suggest what to do with an intrusion</li>
  <li>Finally, the intrusion details are collected and <strong>logged</strong>. <strong>Alerts</strong> will be sent to admins and optionally, scripted <strong>actions</strong> can be performed in according to policies.</li>
</ul>

<p>Two typical examples of NIDS are <a href="https://www.snort.org/">Snort IDS</a> and <a href="https://bricata.com/blog/zeek-ids-threat-detection/">Bro IDS</a>.
A nicer example that can be integrated into network monitoring can be <a href="https://www.zabbix.com/features#smart_thresholds">Zabbix’s Problem Detection Engine</a>.</p>

<h1 id="machine-learning-at-scale-some-solutions-in-aws">Machine Learning at scale: some solutions in AWS</h1>

<h2 id="overview">Overview</h2>

<p>The theory about NIDS perhaps is a huge bundle of knowledge!
Corporations have set up their own NIDS (in most cases in DMZ) for years.
We will not talk about such solutions anymore.
The most interesting part is in the cloud platforms like AWS.</p>

<blockquote>
  <p>While companies are moving their resources to the cloud, where is the NIDS?</p>
</blockquote>

<p>In the <a href="https://d1.awsstatic.com/Marketplace/scenarios/security/SEC_01_TSB_Final.pdf"><strong>Shared Responsibility Model (SRM)</strong></a>.
The <strong>responsibility</strong> of protecting cloud resources like computing instances (EC2) and networking is of AWS.
Users have the responsibility to tune the best configurations of firewall, instances, load balancers, and other resources in AWS.
So a platform IDS is already managed at AWS, and the at the users (application developers), the remaining task is to <strong>implement a best Network/HIDS (endpoint protection)</strong>.
There are several choices for a HIDS in the AWS Marketplace like <a href="https://www.trendmicro.com/en_us/business/products/hybrid-cloud/security-data-center-virtualization.html">TrendMicro’s Deep Security</a>.
For a custom NIDS, users can implement a <a href="https://aws.amazon.com/blogs/networking-and-content-delivery/centralized-inspection-architecture-with-aws-gateway-load-balancer-and-aws-transit-gateway/">Transit DMZ Gateway</a>. 
An examplar implementation can be as follows:</p>

<p><img src="https://github.com/aws-samples/aws-gateway-load-balancer-code-samples/raw/964874069c0a90d0b6758b2612c2de44a43f2a21/aws-cloudformation/centralized_architecture/images/gwlb_centralized_architecture.jpg" alt="AWS Transit gateway" /></p>

<h2 id="challenges-in-nids-operations">Challenges in NIDS operations</h2>

<p>A standard DMZ with NIDS can be implemented at the cloud or data center.
However, the <strong>hurdle</strong> only comes when we operate our solution: this is the hard part!</p>

<blockquote>
  <p>When it comes to operations (運用保守), it often require an enormous amount of manual work!</p>
</blockquote>

<p>We need a large number of low-paid workers who will sit in front of the monitoring screen and then manually mark each access as legal or not.
It is the real-world hurdle!</p>

<blockquote>
  <p>However, the technical issues start when we want <strong>automation</strong>: how to reduce false alarms and misses?</p>
</blockquote>

<p>Good automated solutions will reduce manual work a lot.
But it is not straightforward!
Rule-based systems can have many misses or false alarms.</p>

<blockquote>
  <p>A weak rule misses many, but a strong rule alerts too much! (So both strong and weak ones are useless!)</p>
</blockquote>

<h1 id="machine-learning-at-local">Machine Learning at local</h1>

<p>You have a dataset and perform some analytics at your local or edge PC.
You don’t use any server or cloud solution at all.</p>

<blockquote>
  <p>You should ask us why do you need to care about these works while cloud platforms already prepare so many ready-to-use solutions for you?</p>
</blockquote>

<p>Agree! Machine learning engineers behind the platforms already do such works (model engineering).
Then when you do these works, that means you are:</p>

<ul>
  <li>A student who is learning ML at an educational place (like university);</li>
  <li>A researcher (or engineer) who perform a project for NGO, government, or a big company (who is building a platform solution); and</li>
  <li>The worst luck: you’re only an ML enthusiast who is looking into ML when you have free time.</li>
</ul>

<p>Not so many people do model engineering on their own laptop (or desktop), so in my experience, they fall into one of these three categories.
For the second category, people in that category is ML engineer/scientist who will make the model for thousands to million application developers over the world (who uses the platforms).
Such category is quite a few, and to be in, you need <strong>qualification</strong>!
The most common cases are in the first.
The third category is possible but is rare and complex: while the first and second category have their own goals with ML (for studying and for works), the third category has no particular purpose.
They only do it in their free time and for fun (like doing a hobby)!
The first and second ones will have outcomes (successes and non-successes), but the third one is only for fun!</p>

<blockquote>
  <p>No one can ban the hobby of a man, and we only do the hobby: we start when we want and stop when we don’t like it anymore!
That’s why I call it (the third category) the worst luck!</p>
</blockquote>

<p>Actually, people in the third category already have another job (but that job does not relate to ML or even AI).
They do ML as hobbies but don’t complete anything (because ML is not their business, even more, ML does not give them bread and butter)!</p>

<blockquote>
  <p>It is said, but in practice, if a thing doesn’t give any benefit, it won’t be done properly!</p>
</blockquote>

<p>Nevertheless, whatever your category is, when you do these things in your local computing environment, ML matters with you in some ways!
We will see what a <strong>local IDS model would look like</strong>.
And, in a synthetic way!</p>

<h2 id="a-kaggle-synthetic-dataset">A Kaggle synthetic dataset</h2>

<p>We start with a synthetic dataset from <a href="https://www.kaggle.com/sampadab17/network-intrusion-detection">Kaggle</a>.</p>

<blockquote>
  <p>The dataset to be audited was provided that consists of a wide variety of intrusions simulated in a military network environment. It created an environment to acquire raw TCP/IP dump data for a network by simulating a typical US Air Force LAN. The LAN was focused like a real environment and blasted with multiple attacks. A connection is a sequence of TCP packets starting and ending at some time duration between which data flows to and from a source IP address to a target IP address under some well-defined protocol. Also, each connection is labeled as either normal or as an attack with exactly one specific attack type. Each connection record consists of about 100 bytes.</p>

  <p>For each TCP/IP connection, 41 quantitative and qualitative features are obtained from normal and attack data (3 qualitative and 38 quantitative features). The class variable has two categories:</p>
  <ul>
    <li>Normal</li>
    <li>Anomalous</li>
  </ul>
</blockquote>

<h3 id="explorative-analysis">Explorative analysis</h3>
<p><img src="/assets/images/ids-kaggle-feature-selection.png" alt="feature selection" />
<em>We notice that not all features are useful. Some features like <code class="language-plaintext highlighter-rouge">is_Host_login</code> have only a constant value.</em></p>

<p>Our dataset is big enough (25K entries) and contains both categorical and numerical features:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
</pre></td><td class="rouge-code"><pre>RangeIndex: 25192 entries, 0 to 25191
Data columns (total 42 columns):
 #   Column                       Non-Null Count  Dtype  
---  ------                       --------------  -----  
 0   duration                     25192 non-null  int64  
 1   protocol_type                25192 non-null  object 
 2   service                      25192 non-null  object 
 3   flag                         25192 non-null  object 
 4   src_bytes                    25192 non-null  int64  
 5   dst_bytes                    25192 non-null  int64  
 6   land                         25192 non-null  int64  
 7   wrong_fragment               25192 non-null  int64  
 8   urgent                       25192 non-null  int64  
 9   hot                          25192 non-null  int64  
 10  num_failed_logins            25192 non-null  int64  
 11  logged_in                    25192 non-null  int64  
 12  num_compromised              25192 non-null  int64  
 13  root_shell                   25192 non-null  int64  
 14  su_attempted                 25192 non-null  int64  
 15  num_root                     25192 non-null  int64  
 16  num_file_creations           25192 non-null  int64  
 17  num_shells                   25192 non-null  int64  
 18  num_access_files             25192 non-null  int64  
 19  num_outbound_cmds            25192 non-null  int64  
 20  is_Host_login                25192 non-null  int64  
 21  is_guest_login               25192 non-null  int64  
 22  count                        25192 non-null  int64  
 23  srv_count                    25192 non-null  int64  
 24  serror_rate                  25192 non-null  float64
 25  srv_serror_rate              25192 non-null  float64
 26  rerror_rate                  25192 non-null  float64
 27  srv_rerror_rate              25192 non-null  float64
 28  same_srv_rate                25192 non-null  float64
 29  diff_srv_rate                25192 non-null  float64
 30  srv_diff_Host_rate           25192 non-null  float64
 31  dst_Host_count               25192 non-null  int64  
 32  dst_Host_srv_count           25192 non-null  int64  
 33  dst_Host_same_srv_rate       25192 non-null  float64
 34  dst_Host_diff_srv_rate       25192 non-null  float64
 35  dst_Host_same_src_port_rate  25192 non-null  float64
 36  dst_Host_srv_diff_Host_rate  25192 non-null  float64
 37  dst_Host_serror_rate         25192 non-null  float64
 38  dst_Host_srv_serror_rate     25192 non-null  float64
 39  dst_Host_rerror_rate         25192 non-null  float64
 40  dst_Host_srv_rerror_rate     25192 non-null  float64
 41  class                        25192 non-null  object 
dtypes: float64(15), int64(23), object(4)
memory usage: 8.1+ MB
</pre></td></tr></tbody></table></code></pre></div></div>
<p><img src="/assets/images/ids.png" style="float: left; margin: 10px; width: 50%;" />
Anyway, this is a synthetic dataset with some characteristics based on simulation.
However, it is close to real-world examples enough.
Next, we will try some machine learning models for predicting anomalies.</p>

<p>With a visualization technique, like T-SNE, we have a diagram of data distribution.
A green point is a normal data point, and a red one is an anomaly.
We can see that it would be hard to draw a linear boundary between normal points and anomalies.</p>

<h3 id="play-with-some-machine-learners">Play with some machine learners</h3>

<p>In this section, we will try two different ML models with two different training/inference strategies:</p>

<ul>
  <li><strong>Generative model with a reconstruction strategy</strong>: the Auto-Encoder</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="c1"># creating the autoencoder model
</span><span class="n">i</span> <span class="o">=</span> <span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">X_train_normal</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],))</span>
<span class="n">encoder</span> <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">)(</span><span class="n">i</span><span class="p">)</span>
<span class="n">encoder</span> <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">)(</span><span class="n">encoder</span><span class="p">)</span>
<span class="n">code</span> <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">)(</span><span class="n">encoder</span><span class="p">)</span>
<span class="n">decoder</span> <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">)(</span><span class="n">code</span><span class="p">)</span>
<span class="n">decoder</span> <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">)(</span><span class="n">decoder</span><span class="p">)</span>
<span class="n">decoder</span> <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="n">X_train_normal</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">activation</span><span class="o">=</span><span class="s">'sigmoid'</span><span class="p">)(</span><span class="n">decoder</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">decoder</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li><strong>Discriminative model with a classification strategy</strong>: the quite classical Random Forest!</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span>
<span class="n">rf</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">criterion</span><span class="o">=</span><span class="s">'gini'</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="training-and-validation">Training and validation</h4>

<p>We need to transform the data a little bit.
It is usual to use <code class="language-plaintext highlighter-rouge">MinMaxScaler</code> to perform data transformation.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">MinMaxScaler</span>
<span class="n">scaler</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">()</span>
<span class="n">X_train_normal</span><span class="p">[</span><span class="n">to_norm</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler</span><span class="p">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train_normal</span><span class="p">[</span><span class="n">to_norm</span><span class="p">])</span>
<span class="n">X_val_normal</span><span class="p">[</span><span class="n">to_norm</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler</span><span class="p">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_val_normal</span><span class="p">[</span><span class="n">to_norm</span><span class="p">])</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>The Auto-Encoder is trained in a reconstruction manner, i. e., it learns to reconstruct the input:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">r</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_normal</span><span class="p">,</span> <span class="n">X_train_normal</span><span class="p">,</span> <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_val_normal</span><span class="p">,</span> <span class="n">X_val_normal</span><span class="p">),</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>But the Random Forest learns to classify data as usual:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">rf</span><span class="p">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y_train_num</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="results-of-auto-encoder">Results of Auto-Encoder</h4>

<p>Since the prediction of AE relies on how good it can reconstruct the input:</p>
<ul>
  <li>If the reconstruction error is over a threshold, then the reconstruction fails, and the input is <code class="language-plaintext highlighter-rouge">anomaly</code>.</li>
  <li>Otherwise, the input is normal.</li>
</ul>

<p>Then we must define a <strong>threshold</strong> to separate anomalies and normal inputs.
To find such threshold, we can compute from the training dataset:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="c1"># reconstructing the train set
</span><span class="n">pred</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_train_normal</span><span class="p">)</span>
<span class="c1"># finding the mean reconstruction error
</span><span class="n">np</span><span class="p">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">power</span><span class="p">(</span><span class="n">pred</span> <span class="o">-</span> <span class="n">X_train_normal</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Since the mean of construction error is 0.0018520295581492838, we can choose the threshold <code class="language-plaintext highlighter-rouge">thres = 0.0018</code>.
Validation in validation set:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="n">X_val</span><span class="p">[</span><span class="n">to_norm</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler</span><span class="p">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_val</span><span class="p">[</span><span class="n">to_norm</span><span class="p">])</span>
<span class="n">pred</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_val</span><span class="p">)</span>
<span class="n">mse</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">power</span><span class="p">(</span><span class="n">pred</span> <span class="o">-</span> <span class="n">X_val</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="c1"># classifying the samples based on threshold
</span><span class="n">pred_class</span> <span class="o">=</span> <span class="p">[</span><span class="s">'anomaly'</span> <span class="k">if</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="n">thres</span> <span class="k">else</span> <span class="s">'normal'</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">mse</span><span class="p">]</span>
<span class="k">print</span><span class="p">(</span><span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_val</span><span class="p">,</span> <span class="n">pred_class</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Acc. = </span><span class="si">{</span><span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_val</span><span class="p">,</span> <span class="n">pred_class</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">}</span><span class="s">[%], F1 = </span><span class="si">{</span><span class="n">f1_score</span><span class="p">(</span><span class="n">y_val</span><span class="p">,</span> <span class="n">pred_class</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="s">'anomaly'</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">}</span><span class="s">[%"</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Results:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>[[2901   69]
 [ 563 2765]]
Acc. = 89.96506827564306[%], F1 = 90.17718371153248[%]
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>~90%</strong> of F1 score. Hmm, not so bad!</p>
<h4 id="results-of-random-forest">Results of Random Forest</h4>

<p>Let’s see the results with Random Forest:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>[[3321    7]
 [  14 2956]]
Acc. = 99.66656081295649[%], F1 = 99.64604753076016[%]
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>99.6%</strong>, it is quite good!</p>

<h2 id="some-methods-for-machine-learning-based-ids">Some methods for Machine Learning based IDS</h2>
<p>There are many ways to identify anomalous access (i. e., intrusion) in the network.</p>

<p><strong>Rule-based methods</strong> tend to find a “good” heuristic that can be generalized to a global policy for all feature space.
The same policy can be applied to every input.
For example, <code class="language-plaintext highlighter-rouge">every connection which lasted for more than 7 minutes are anomalies</code> is a policy to identify intrusions.
The problem with this approach is that many false negatives (misses) can be raised.
Because the rule is clear, counterfactuals try to make themselves legal (try to connect faster) and overcome the 7-minute rule.
So a fixed rule is not enough.</p>

<blockquote>
  <p>The attacks become more and more advanced, but the rules cannot be changed so fast, making an <code class="language-plaintext highlighter-rouge">Achilles' heel</code> in the defense system.</p>
</blockquote>

<p><strong>Machine Learning-based methods</strong> try to define a soft boundary that can be learned and improved over time.
The main advantage of the Machine Learning approach is that since the boundary is soft and there is no clear rule, the intruders cannot know the rule exactly (how many minutes should they make for a successful intrusion?).
Another important aspect is that since the soft rule is not fixed, it can <strong>evolve</strong> with the intrusions: the more advanced the intrusion is, the more advanced the defender is.
When this sounds <em>ambiguous</em>, but for the security systems, it becomes exactly a common strategy to overcome incidents.
The Machine Learning methods can be generative or discriminative, but they must be somewhat non-linear and ambiguous enough to hide details of the system to hackers.</p>

<h1 id="conclusion">Conclusion</h1>

<p>We have reviewed several views of NIDS: at a corporation network view, cloud solutions, and machine learning models.</p>

<p>On the synthetic examples, we observed that a quite classical model like <strong>Random Forest</strong> can outperform neural nets.
It is not a new thing: we already <em>empirically</em> knew that Random Forest is good at this problem, especially when it is in synthetic environments.
Somebody can argue that there is a chance for overfitting with Random Forest: hmm, I don’t think so.</p>

<blockquote>
  <p>And even if it overfits, this is quite good, because <strong>that’s what we want</strong>: <strong>We want our model to overfit to this dataset</strong>.</p>

  <p>Anonymous</p>
</blockquote>

<p>Source code for this article can be found at:</p>

<ul>
  <li><a href="https://github.com/AIFI-INC/ml-ids">AIFI-INC’s ML-based IDS</a></li>
</ul>

            </div>

            <!-- Rating -->
            

            <!-- Post Date -->
            <p>
            <small>
                <span class="post-date"><time class="post-date" datetime="2022-01-29">29 Jan 2022</time></span>           
                
                </small>
            </p>

            <!-- Post Categories -->
            <div class="after-post-cats">
                <ul class="tags mb-4">
                    
                    
                    <li>
                        <a class="smoothscroll" href="https://wanted2.github.io/categories#Artificial-Intelligence">Artificial Intelligence</a>
                    </li>
                    
                    <li>
                        <a class="smoothscroll" href="https://wanted2.github.io/categories#Site-Reliable-Engineering">Site Reliable Engineering</a>
                    </li>
                    
                    <li>
                        <a class="smoothscroll" href="https://wanted2.github.io/categories#Software-Engineering">Software Engineering</a>
                    </li>
                    
                </ul>
            </div>
            <!-- End Categories -->

            <!-- Post Tags -->
            <div class="after-post-tags">
                <ul class="tags">
                    
                    
                    <li>
                        <a class="smoothscroll" href="https://wanted2.github.io/tags#Machine-learning">#Machine learning</a>
                    </li>
                    
                    <li>
                        <a class="smoothscroll" href="https://wanted2.github.io/tags#edge-computing">#edge computing</a>
                    </li>
                    
                    <li>
                        <a class="smoothscroll" href="https://wanted2.github.io/tags#iot">#iot</a>
                    </li>
                    
                    <li>
                        <a class="smoothscroll" href="https://wanted2.github.io/tags#network-intrusion-detection">#network intrusion detection</a>
                    </li>
                    
                    <li>
                        <a class="smoothscroll" href="https://wanted2.github.io/tags#threat-intelligence">#threat intelligence</a>
                    </li>
                    
                </ul>
            </div>
            <!-- End Tags -->

            <!-- Prev/Next -->
            <div class="row PageNavigation d-flex justify-content-between font-weight-bold">
            
            <a class="prev d-block col-md-6" href="https://wanted2.github.io//pm-sekininsha/"> &laquo; 責任者</a>
            
            
            <a class="next d-block col-md-6 text-lg-right" href="https://wanted2.github.io//seq2seq/">Seq2Seq và kiến trúc Encoder-Decoder &raquo; </a>
            
            <div class="clearfix"></div>
            </div>
            <!-- End Categories -->

        </div>
        <!-- End Post -->

    </div>
</div>
<!-- End Article
================================================== -->

<!-- Begin Comments
================================================== -->

    <div class="container">
        <div id="comments" class="row justify-content-center mb-5">
            <div class="col-md-8">
                <section class="disqus">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'caineng'; 
        var disqus_developer = 0;
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = window.location.protocol + '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>

            </div>
        </div>
    </div>

<!--End Comments
================================================== -->

<!-- Review with LD-JSON, adapt it for your needs if you like, but make sure you test the generated HTML source code first: 
https://search.google.com/structured-data/testing-tool/u/0/
================================================== -->

</div>


<!-- Bottom Alert Bar
================================================== -->
<div class="alertbar">
	<div class="container text-center">
		<span><img src="https://wanted2.github.io/assets/images/favicon.ico" alt="AiFi" style="max-height: 48px;" /> &nbsp; Never miss a <b>story</b> from us, subscribe to our newsletter</span>
        <form action="https://caineng.us20.list-manage.com/subscribe/post?u=76342d3d74a6807aac5aec0d7&id=b5645e19be" method="post" name="mc-embedded-subscribe-form" class="wj-contact-form validate" target="_blank" novalidate>
            <div class="mc-field-group">
            <input type="email" placeholder="Email" name="EMAIL" class="required email" id="mce-EMAIL" autocomplete="on" required>
            <input type="submit" value="Subscribe" name="subscribe" class="heart">
            </div>
        </form>
	</div>
</div>

    
</div>

<!-- Categories Jumbotron
================================================== -->
<div class="jumbotron fortags">
	<div class="d-md-flex h-100">
		<div class="col-md-4 transpdark align-self-center text-center h-100">
            <div class="d-md-flex align-items-center justify-content-center h-100">
                <h2 class="d-md-block align-self-center py-1 font-weight-light">Explore <span class="d-none d-md-inline">→</span></h2>
            </div>
		</div>
		<div class="col-md-8 p-5 align-self-center text-center">
            
            
                
                    <a class="mt-1 mb-1" href="https://wanted2.github.io/categories#Site-Reliable-Engineering">Site Reliable Engineering (16)</a>
                
                    <a class="mt-1 mb-1" href="https://wanted2.github.io/categories#Software-Engineering">Software Engineering (37)</a>
                
                    <a class="mt-1 mb-1" href="https://wanted2.github.io/categories#Computer-Vision">Computer Vision (5)</a>
                
                    <a class="mt-1 mb-1" href="https://wanted2.github.io/categories#Artificial-Intelligence">Artificial Intelligence (19)</a>
                
                    <a class="mt-1 mb-1" href="https://wanted2.github.io/categories#Tiếng-Việt,-日本語">Tiếng Việt, 日本語 (37)</a>
                
                    <a class="mt-1 mb-1" href="https://wanted2.github.io/categories#Project-Management">Project Management (34)</a>
                
            
            
		</div>
	</div>
</div>

<!-- Begin Footer
================================================== -->
<footer class="footer">
    <div class="container">
        <div class="row">
            <div class="col-md-6 col-sm-6 text-center text-lg-left">
                Copyright © 2022 AiFi 
            </div>
            <div class="col-md-6 col-sm-6 text-center text-lg-right">    
                <a target="_blank" href="https://www.wowthemes.net/mediumish-free-jekyll-template/">Mediumish Jekyll Theme</a> by WowThemes.net
            </div>
        </div>
    </div>
</footer>
<!-- End Footer
================================================== -->

</div> <!-- /.site-content -->

<!-- Scripts
================================================== -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>

<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>

<script src="https://wanted2.github.io/assets/js/mediumish.js"></script>


<script src="https://wanted2.github.io/assets/js/lazyload.js"></script>


<script src="https://wanted2.github.io/assets/js/ie10-viewport-bug-workaround.js"></script> 


<script id="dsq-count-scr" src="//caineng.disqus.com/count.js"></script>


</body>
</html>
