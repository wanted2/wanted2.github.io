<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<link rel="icon" href="https://wanted2.github.io/assets/images/favicon.ico">

<title>Amazon Lexと文章連想検索を用いた音声検索チャットボットの実現 | AiFi</title>


  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-2CDTCF0EP6" crossorigin="anonymous"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-2CDTCF0EP6');
  </script>


<!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Amazon Lexと文章連想検索を用いた音声検索チャットボットの実現 | AiFi</title>
<meta name="generator" content="Jekyll v4.2.1" />
<meta property="og:title" content="Amazon Lexと文章連想検索を用いた音声検索チャットボットの実現" />
<meta name="author" content="tuan" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="音声認識による文章連想検索システムは、ユーザの音声入力に対して、決まった言葉で検索エンジンを起動して、関連する文章の一覧を返すシステムです。 本稿では、アマゾンLexやElasticsearchなどの既製部品を使ってシステムを構築する話題を挙げます。" />
<meta property="og:description" content="音声認識による文章連想検索システムは、ユーザの音声入力に対して、決まった言葉で検索エンジンを起動して、関連する文章の一覧を返すシステムです。 本稿では、アマゾンLexやElasticsearchなどの既製部品を使ってシステムを構築する話題を挙げます。" />
<meta property="og:site_name" content="AiFi" />
<meta property="og:image" content="/https://wanted2.github.io/assets/images/rensou1.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-07-24T00:00:00+09:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="/https://wanted2.github.io/assets/images/rensou1.png" />
<meta property="twitter:title" content="Amazon Lexと文章連想検索を用いた音声検索チャットボットの実現" />
<script type="application/ld+json">
{"mainEntityOfPage":{"@type":"WebPage","@id":"/https://wanted2.github.io/python-amazon-lex-chatbot-elasticsearch/"},"description":"音声認識による文章連想検索システムは、ユーザの音声入力に対して、決まった言葉で検索エンジンを起動して、関連する文章の一覧を返すシステムです。 本稿では、アマゾンLexやElasticsearchなどの既製部品を使ってシステムを構築する話題を挙げます。","image":"/https://wanted2.github.io/assets/images/rensou1.png","headline":"Amazon Lexと文章連想検索を用いた音声検索チャットボットの実現","dateModified":"2021-07-24T00:00:00+09:00","datePublished":"2021-07-24T00:00:00+09:00","url":"/https://wanted2.github.io/python-amazon-lex-chatbot-elasticsearch/","author":{"@type":"Person","name":"tuan"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"/https://wanted2.github.io/assets/images/favicon.ico"},"name":"tuan"},"@type":"BlogPosting","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    
<link href="https://wanted2.github.io/assets/css/screen.css" rel="stylesheet">

<link href="https://wanted2.github.io/assets/css/main.css" rel="stylesheet">

<script src="https://wanted2.github.io/assets/js/jquery.min.js"></script>
<script src="https://kit.fontawesome.com/d0b91d895e.js" crossorigin="anonymous"></script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        processEscapes: true
    }
    });
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript" crossorigin="anonymous"></script>
<script src="https://d3js.org/d3.v4.js" crossorigin="anonymous"></script>
<!-- <script src="https://bl.ocks.org/mbostock/raw/4061502/0a200ddf998aa75dfdb1ff32e16b680a15e5cb01/box.js" crossorigin="anonymous"></script> -->
</head>


<body class="layout-post">
	<!-- defer loading of font and font awesome -->
	<noscript id="deferred-styles">
		<link href="https://fonts.googleapis.com/css?family=Righteous%7CMerriweather:300,300i,400,400i,700,700i" rel="stylesheet">
		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
	</noscript>


<!-- Begin Menu Navigation
================================================== -->
<nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top mediumnavigation nav-down">

    <div class="container pr-0">

    <!-- Begin Logo -->
    <a class="navbar-brand" href="https://wanted2.github.io/">
    <img src="https://wanted2.github.io/assets/images/favicon.ico" alt="AiFi">
    </a>
    <!-- End Logo -->

    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarMediumish" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarMediumish">

        <!-- Begin Menu -->

            <ul class="navbar-nav ml-auto">

                
                <li class="nav-item">
                
                <a class="nav-link" href="https://wanted2.github.io/">Blog</a>
                </li>

                <li class="nav-item">
                <a class="nav-link" href="https://wanted2.github.io/about">About</a>
                </li>

                <li class="nav-item">
                <a class="nav-link" href="https://wanted2.github.io/projects">Projects</a>
                </li>

                <!-- <li class="nav-item">
                <a target="_blank" class="nav-link" href="https://bootstrapstarter.com/bootstrap-templates/template-mediumish-bootstrap-jekyll/"> Docs</a>
                </li>

                <li class="nav-item">
                <a target="_blank" class="nav-link" href="https://www.wowthemes.net/themes/mediumish-wordpress/"><i class="fab fa-wordpress-simple"></i> WP Version</a>
                </li>

                <li class="nav-item">
                <a target="_blank" class="nav-link" href="https://www.wowthemes.net/themes/mediumish-ghost/"><i class="fab fa-snapchat-ghost"></i> Ghost Version</a>
                </li>

                <li class="nav-item">
                <a target="_blank" class="nav-link" href="https://github.com/wowthemesnet/mediumish-theme-jekyll"><i class="fab fa-github"></i> Fork on Github</a>
                </li> -->

                <!-- <script src="https://wanted2.github.io/assets/js/lunr.js"></script>


<style>
    .lunrsearchresult .title {color: #d9230f;}
    .lunrsearchresult .url {color: silver;}
    .lunrsearchresult a {display: block; color: #777;}
    .lunrsearchresult a:hover, .lunrsearchresult a:focus {text-decoration: none;}
    .lunrsearchresult a:hover .title {text-decoration: underline;}
</style>


<form class="bd-search" onSubmit="return lunr_search(document.getElementById('lunrsearch').value);">
    <input type="text" class="form-control text-small launch-modal-search" id="lunrsearch" name="q" maxlength="255" value="" placeholder="Type and enter..."/>
</form>

<div id="lunrsearchresults">
    <ul></ul>
</div>

<script src="https://wanted2.github.io/assets/js/lunrsearchengine.js"></script> -->

            </ul>

        <!-- End Menu -->

    </div>

    </div>
</nav>
<!-- End Navigation
================================================== -->

<div class="site-content">

<div class="container">

<!-- Site Title
================================================== -->
<div class="mainheading">
    <h1 class="sitetitle">AiFi</h1>
    <p class="lead">
        An AI Engineer's blog
    </p>
</div>

<!-- Content
================================================== -->
<div class="main-content">
    <!-- Begin Article
================================================== -->
<div class="container">
    <div class="row">

        <!-- Post Share -->
        <div class="col-md-2 pl-0">
            <div class="share sticky-top sticky-top-offset">
    <p>
        Share
    </p>
    <ul>
        <li class="ml-1 mr-1">
            <a target="_blank" href="https://twitter.com/intent/tweet?text=Amazon Lexと文章連想検索を用いた音声検索チャットボットの実現&url=https://wanted2.github.io/python-amazon-lex-chatbot-elasticsearch/" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                <i class="fab fa-twitter"></i>
            </a>
        </li>

        <li class="ml-1 mr-1">
            <a target="_blank" href="https://facebook.com/sharer.php?u=https://wanted2.github.io/python-amazon-lex-chatbot-elasticsearch/" onclick="window.open(this.href, 'facebook-share', 'width=550,height=435');return false;">
                <i class="fab fa-facebook-f"></i>
            </a>
        </li>

        <li class="ml-1 mr-1">
            <a target="_blank" href="https://www.linkedin.com/shareArticle?mini=true&url=https://wanted2.github.io/python-amazon-lex-chatbot-elasticsearch/" onclick="window.open(this.href, 'width=550,height=435');return false;">
                <i class="fab fa-linkedin-in"></i>
            </a>
        </li>

        <li class="ml-1 mr-1">
            <a target="_blank" href="mailto:?subject=Amazon Lexと文章連想検索を用いた音声検索チャットボットの実現&body=https://wanted2.github.io/python-amazon-lex-chatbot-elasticsearch/" onclick="window.open(this.href, 'width=550,height=435');return false;">
                <i class="fas fa-envelope"></i>
            </a>
        </li>

    </ul>
    
    <div class="sep">
    </div>
    <ul>
        <li>
        <a class="small smoothscroll" href="#disqus_thread"></a>
        </li>
    </ul>
    
</div>

        </div>

        <!-- Post -->
        

        <div class="col-md-9 flex-first flex-md-unordered">
            <div class="mainheading">

                <!-- Author Box -->
                
                <div class="row post-top-meta">
                    <div class="col-xs-12 col-md-2 col-lg-2 text-left mb-4 mb-md-0">
                        
                        <img class="author-thumb" src="https://wanted2.github.io/assets/images/favicon.png" alt="AiFi">
                        
                    </div>
                    <div class="col-xs-12 col-md-10 col-lg-10 text-right">
                        <a target="_blank" class="link-dark" href="">AiFi</a>
                        <!-- <a target="_blank" href="" class="btn follow">Follow</a> -->
                        <!-- LikeBtn.com BEGIN -->
                        <span class="likebtn-wrapper" 
                            data-site_id="61cfccd36fd08b2d68c1929e"
                            data-theme="custom" 
                            data-icon_l_url="/assets/images/OK_EM.png" 
                            data-icon_l_url_v="/assets/images/OK_EM_clicked.png" 
                            data-identifier="/python-amazon-lex-chatbot-elasticsearch/" 
                            data-show_like_label="false" 
                            data-like_enabled="false" 
                            data-dislike_enabled="false" 
                            data-icon_dislike_show="false" 
                            data-voting_cancelable="false" 
                            data-counter_show="true"
                            data-counter_frmt="comma"></span>
                        <script>(function(d,e,s){if(d.getElementById("likebtn_wjs"))return;a=d.createElement(e);m=d.getElementsByTagName(e)[0];a.async=1;a.id="likebtn_wjs";a.src=s;m.parentNode.insertBefore(a, m)})(document,"script","//w.likebtn.com/js/w/widget.js");</script>
                        <!-- LikeBtn.com END -->
                        <span class="author-description"></span>
                    </div>
                </div>
                

                <!-- Post Title -->
                <h1 class="posttitle">Amazon Lexと文章連想検索を用いた音声検索チャットボットの実現</h1>

            </div>

            <!-- Adsense if enabled from _config.yml (change your pub id and slot) -->
            
            <!-- End Adsense -->

            <!-- Post Featured Image -->
            

            
            <img class="featured-image img-fluid lazyimg" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAMAAAACCAQAAAA3fa6RAAAADklEQVR42mNkAANGCAUAACMAA2w/AMgAAAAASUVORK5CYII=" data-src="https://wanted2.github.io/assets/images/rensou1.png" alt="Amazon Lexと文章連想検索を用いた音声検索チャットボットの実現">
            

            
            <!-- End Featured Image -->

            <!-- Post Content -->
            <div class="article-post">
                <!-- Toc if any -->
                
                    
                    <div class="toc mt-4 mb-4 lead">
                        <h3 class="font-weight-bold">Summary</h3>
                        <ul>
  <li><a href="#はじめに">はじめに</a></li>
  <li><a href="#既製部品">既製部品</a>
    <ul>
      <li><a href="#アマゾンlexによる音声チャットボット">アマゾンLexによる音声チャットボット</a></li>
      <li><a href="#elasticsearchによる連想検索">Elasticsearchによる連想検索</a></li>
    </ul>
  </li>
  <li><a href="#実現と結果">実現と結果</a>
    <ul>
      <li><a href="#文書データベース索引の作成フローの自動化">文書データベース索引の作成フローの自動化</a></li>
      <li><a href="#チャットボットへのインテグレーション">チャットボットへのインテグレーション</a></li>
      <li><a href="#考察">考察</a>
        <ul>
          <li><a href="#メリット">メリット</a></li>
          <li><a href="#デメリット">デメリット</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#おわりに">おわりに</a></li>
  <li><a href="#参考文献">参考文献</a></li>
</ul>
                    </div>
                
                <!-- End Toc -->
                <p><strong>音声認識による文章連想検索システム</strong>は、ユーザの音声入力に対して、決まった言葉で検索エンジンを起動して、関連する文章の一覧を返すシステムです。
本稿では、アマゾンLexやElasticsearchなどの既製部品を使ってシステムを構築する話題を挙げます。
<!--more--></p>

<h1 id="はじめに">はじめに</h1>

<p>SlackやTwilioなどで音声認識チャットボットを想定します。</p>

<ol>
  <li>1万冊以上論文を保管する時、「音声認識」に関する文献を検索したいです。
その1万冊は別でアマゾンS3にアップロードして保管します。
検索エンジンにデータの索引を作る。</li>
  <li>ユーザが「私は音声認識について知りたいです。」を音声で入力すると、ボットが「音声認識」を理解して、検索を稼働させる。</li>
  <li>入力キーワード「音声認識」に対して検索を行い、結果一覧を返す。</li>
</ol>

<p>1.と3.はアマゾンElasticsearchとS3で実現できます。
索引作成処理と検索処理はラムダで実現できます。
2.はアマゾンLexで作れます。</p>

<h1 id="既製部品">既製部品</h1>

<h2 id="アマゾンlexによる音声チャットボット">アマゾンLexによる音声チャットボット</h2>

<p><img src="/assets/images/lex1.png" style="float: right; margin: 10px; width: 50%" /></p>

<p>アマゾンLexは会話チャットボットを作る支援プラットフォームです。
開発者は会話のスクリプトを考えて、そのスクリプトを実現するために、Lexの<strong>インテント</strong>を使います。
チャットボットの作成だけではなく、テストや他のプラットフォームへのインテグレーションもサポートします。
英語だけではなく、日本語やスペイン語などの英語以外の言語も対応します。
また、音声以外にテキストで入力することも可能です。</p>

<p>ここで、インテグレーションのために重要な概念を説明します。
インテントはスクリプトのことですが、インテントの構成と作成方法です。
Pythonでコーディングするなら、<code class="language-plaintext highlighter-rouge">boto3</code>ライブラリ[1]の<a href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/lexv2-models.html#LexModelsV2.Client.create_bot"><code class="language-plaintext highlighter-rouge">create_bot</code>メソッド</a>を参考すれば良いでしょう。
会話フローを実現するために、重要な要素は<strong>コンテキスト、サンプル、プロムプト、スロットとフック</strong>です。</p>

<table>
  <thead>
    <tr>
      <th>要素</th>
      <th>説明</th>
      <th>例</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>コンテキスト</td>
      <td>入力と出力の時に、状態制御変数のこと。入力コンテキストが有効でない場合、応答インテントをしないなどの制御を実現できる。</td>
      <td>―</td>
    </tr>
    <tr>
      <td>サンプル</td>
      <td>インテントを起動する言葉。</td>
      <td>「こんにちは」、「ピザを注文したいです。」</td>
    </tr>
    <tr>
      <td>プロムプト</td>
      <td>「はい・いいえ」だけの質問。回答後、終了を確認するか、ユーザが満足できたか確認質問。</td>
      <td>「いかがでしょうか」、「回答に満足できましたか。」、「○○ピザを注文しました。いかがでしょうか。」</td>
    </tr>
    <tr>
      <td>終了レスポンス</td>
      <td>終了時、最後に出す言葉。または、別のインテントを起動する質問を出すことも可能。</td>
      <td>「ご注文どうもありがとうございました。今○○製品にキャンペーンを実現していますけれども、追加注文しませんか。」</td>
    </tr>
    <tr>
      <td>スロット</td>
      <td>インテントを実行するときに必要な既定変数。</td>
      <td>―</td>
    </tr>
    <tr>
      <td>フック</td>
      <td>インテントの実行関数、あるいは、入力バリデーションなどを設定できる。</td>
      <td>ラムダのARN</td>
    </tr>
  </tbody>
</table>

<p>これだけの情報を入力することで、インテントを作成できます。
実は、音声で入力するが、アマゾンの既製音声認識でやっています。
特に、音声認識の中身に触れることなく、システム構築できますので、音声認識の知識がなくても安心してください。</p>

<h2 id="elasticsearchによる連想検索">Elasticsearchによる連想検索</h2>

<p><img src="/assets/images/elasticsearch1.png" alt="" /></p>

<blockquote>
  <p>Amazon Elasticsearch Service は、Elasticsearch を大規模かつ簡単でコスト効率の良い方法を使用してデプロイ、保護、実行する完全マネージド型サービスです。好きなツールを使用して、必要な規模でアプリケーションを構築、監視、およびトラブルシューティングできます。このサービスは、オープンソースの Elasticsearch API、マネージド Kibana、Logstash とその他の AWS サービスとの統合、組み込みのアラートと SQL クエリのサポートを提供します。Amazon Elasticsearch Service は従量課金制です。前払い費用や最低料金はありません。Amazon Elasticsearch Service では、必要なだけの ELK スタックをランニングコストなしで入手できます。
出典：<a href="https://aws.amazon.com/jp/elasticsearch-service/?nc1=h_ls">Amazon Elasticsearch</a></p>
</blockquote>

<p>大規模の文章データの高速検索を実現するためのプラットフォームです。
Elasticsearch本番では<strong>全文検索</strong>など、キーワードを連想する検索も実現されています。
図で説明するとネットで調べてみたが、<a href="https://itdepends.hateblo.jp/entry/2019/01/31/191552#%E6%A4%9C%E7%B4%A2%E3%83%97%E3%83%AD%E3%82%BB%E3%82%B9%E3%81%AE%E8%A6%8B%E6%A5%B5%E3%82%81">はてなBlog</a>を引用しています。
これはElasticsearchのクエリ検索の仕組みを良く表現できたと思います。
クエリビルダーでは、ANDとOR演算子でキーワード配列を連想して、強力なクエリを新たに定義します。
事前に作った索引と<code class="language-plaintext highlighter-rouge">multi_match</code>で検索します。
0件という結果が帰ると、救済処理などを行えますが、それが今回のスコープに入りません。</p>

<p>このようにすると、Lexで認識したインテントをElasticsearchで<strong>文章連想検索</strong>を実現できます。</p>

<h1 id="実現と結果">実現と結果</h1>

<table>
  <thead>
    <tr>
      <th>部品</th>
      <th>説明</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Amazon Lex</td>
      <td>音声認識と会話フローを実現する</td>
    </tr>
    <tr>
      <td>Fulfilment Lambda</td>
      <td>「○○について知りたいです。」というクエリが来ると、実行する処理を記述するラムダ関数。その処理は、Elasticsearchのエンドポイントにクエリを投げ、結果が返るのを待機する。</td>
    </tr>
    <tr>
      <td>Elasticsearch service</td>
      <td>文章データの索引と連想検索を行う。</td>
    </tr>
    <tr>
      <td>Indexing Lambda</td>
      <td>文章データがアップされると、トリガー処理を行う。データをElasticsearchのエンドポイントに送る処理を行う。</td>
    </tr>
    <tr>
      <td>Document Storage S3</td>
      <td>文章データが保管されるストレージ。手動でアップする。</td>
    </tr>
  </tbody>
</table>

<h2 id="文書データベース索引の作成フローの自動化">文書データベース索引の作成フローの自動化</h2>

<p>PDFデータやOfficeデータをS3にアップして、Elasticsearchのエンドポイントへ送信するフローを自動化したいです。
つまり、<code class="language-plaintext highlighter-rouge">Document Storage S3 ---&gt; Indexing Lambda ---&gt; Elasticsearch Service</code>のフローを自動化します。</p>

<p>この部分の設計は下記になります[2]。</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
</pre></td><td class="rouge-code"><pre>  <span class="na">ESNS3Access</span><span class="pi">:</span>
    <span class="na">Type</span><span class="pi">:</span> <span class="s1">'</span><span class="s">AWS::IAM::Policy'</span>
    <span class="na">Properties</span><span class="pi">:</span>
      <span class="na">PolicyName</span><span class="pi">:</span> <span class="s">ESNS3Access</span>
      <span class="na">PolicyDocument</span><span class="pi">:</span>
        <span class="na">Version</span><span class="pi">:</span> <span class="s">2012-10-17</span>
        <span class="na">Statement</span><span class="pi">:</span>
          <span class="pi">-</span> 
            <span class="na">Effect</span><span class="pi">:</span> <span class="s">Allow</span>
            <span class="na">Action</span><span class="pi">:</span>
              <span class="pi">-</span> <span class="s">es:ESHttpGet</span>
              <span class="pi">-</span> <span class="s">es:ESHttpPost</span>
              <span class="pi">-</span> <span class="s">es:ESHttpPut</span>
            <span class="na">Resource</span><span class="pi">:</span>
              <span class="kt">!Join</span>
              <span class="pi">-</span> <span class="s1">'</span><span class="s">'</span>
              <span class="pi">-</span> <span class="pi">-</span> <span class="kt">!GetAtt</span> <span class="s">ElasticsearchDomain.Arn</span>
                <span class="pi">-</span> <span class="s2">"</span><span class="s">/*"</span>
          <span class="pi">-</span>
            <span class="na">Effect</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Allow"</span>
            <span class="na">Action</span><span class="pi">:</span> <span class="s2">"</span><span class="s">s3:GetObject*"</span>
            <span class="na">Resource</span><span class="pi">:</span> <span class="kt">!Sub</span> <span class="s2">"</span><span class="s">arn:aws:s3:::${AWS::StackName}-${AWS::AccountId}-documentstore/*"</span>
      <span class="na">Roles</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="kt">!Ref</span> <span class="s">IndexDocumentLambdaExecutionRole</span>

  <span class="na">IndexDocumentLambdaExecutionRole</span><span class="pi">:</span>
    <span class="na">Type</span><span class="pi">:</span> <span class="s2">"</span><span class="s">AWS::IAM::Role"</span>
    <span class="na">Properties</span><span class="pi">:</span>
      <span class="na">AssumeRolePolicyDocument</span><span class="pi">:</span>
        <span class="na">Version</span><span class="pi">:</span> <span class="s2">"</span><span class="s">2012-10-17"</span>
        <span class="na">Statement</span><span class="pi">:</span>
          <span class="pi">-</span>
            <span class="na">Effect</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Allow"</span>
            <span class="na">Principal</span><span class="pi">:</span>
              <span class="na">Service</span><span class="pi">:</span>
                <span class="pi">-</span> <span class="s2">"</span><span class="s">lambda.amazonaws.com"</span>
            <span class="na">Action</span><span class="pi">:</span>
              <span class="pi">-</span> <span class="s2">"</span><span class="s">sts:AssumeRole"</span>
      <span class="na">Path</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/"</span>
      <span class="na">ManagedPolicyArns</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s2">"</span><span class="s">arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"</span>

  <span class="na">IndexDocumentLambda</span><span class="pi">:</span>
    <span class="na">Type</span><span class="pi">:</span> <span class="s2">"</span><span class="s">AWS::Lambda::Function"</span>
    <span class="na">Properties</span><span class="pi">:</span>
      <span class="na">Code</span><span class="pi">:</span>
        <span class="na">S3Bucket</span><span class="pi">:</span> <span class="s2">"</span><span class="s">aws-machine-learning-blog"</span>
        <span class="na">S3Key</span><span class="pi">:</span> <span class="s2">"</span><span class="s">artifacts/document-search-bot/es-index.zip"</span>
      <span class="na">Description</span><span class="pi">:</span> <span class="s">This function is used to convert documents to base64 and upload index it in Elasticsearch</span>
      <span class="na">FunctionName</span><span class="pi">:</span> <span class="kt">!Sub</span> <span class="s2">"</span><span class="s">${AWS::StackName}-IndexDocumentLambda"</span>
      <span class="na">Handler</span><span class="pi">:</span> <span class="s">index.handler</span>
      <span class="na">MemorySize</span><span class="pi">:</span> <span class="m">256</span>
      <span class="na">Role</span><span class="pi">:</span> <span class="kt">!GetAtt</span> <span class="s">IndexDocumentLambdaExecutionRole.Arn</span>
      <span class="na">Runtime</span><span class="pi">:</span> <span class="s2">"</span><span class="s">nodejs12.x"</span>
      <span class="na">Timeout</span><span class="pi">:</span> <span class="m">25</span>
      <span class="na">Environment</span><span class="pi">:</span>
        <span class="na">Variables</span><span class="pi">:</span>
            <span class="na">ESENDPOINT</span><span class="pi">:</span>
              <span class="kt">!Join</span>
                <span class="pi">-</span> <span class="s1">'</span><span class="s">'</span>
                <span class="pi">-</span> <span class="pi">-</span> <span class="s2">"</span><span class="s">https://"</span>
                  <span class="pi">-</span> <span class="kt">!GetAtt</span> <span class="s">ElasticsearchDomain.DomainEndpoint</span>
            <span class="na">AWSREGION</span><span class="pi">:</span> <span class="kt">!Ref</span> <span class="s">AWS::Region</span>

  <span class="na">ElasticsearchDomain</span><span class="pi">:</span>
      <span class="na">Type</span><span class="pi">:</span> <span class="s2">"</span><span class="s">AWS::Elasticsearch::Domain"</span>
      <span class="na">Properties</span><span class="pi">:</span>
        <span class="na">ElasticsearchClusterConfig</span><span class="pi">:</span>
          <span class="na">DedicatedMasterEnabled</span><span class="pi">:</span> <span class="no">false</span>
          <span class="na">InstanceCount</span><span class="pi">:</span> <span class="m">1</span>
          <span class="na">InstanceType</span><span class="pi">:</span> <span class="s">t2.small.elasticsearch</span>
          <span class="na">ZoneAwarenessEnabled</span><span class="pi">:</span> <span class="s1">'</span><span class="s">false'</span>
        <span class="na">EBSOptions</span><span class="pi">:</span>
          <span class="na">EBSEnabled</span><span class="pi">:</span> <span class="no">true</span>
          <span class="na">Iops</span><span class="pi">:</span> <span class="m">0</span>
          <span class="na">VolumeSize</span><span class="pi">:</span> <span class="m">10</span>
          <span class="na">VolumeType</span><span class="pi">:</span> <span class="s2">"</span><span class="s">gp2"</span>
        <span class="na">ElasticsearchVersion</span><span class="pi">:</span> <span class="s2">"</span><span class="s">6.2"</span>
        <span class="na">SnapshotOptions</span><span class="pi">:</span>
          <span class="na">AutomatedSnapshotStartHour</span><span class="pi">:</span> <span class="s2">"</span><span class="s">0"</span>
        <span class="na">AdvancedOptions</span><span class="pi">:</span>
          <span class="na">rest.action.multi.allow_explicit_index</span><span class="pi">:</span> <span class="s1">'</span><span class="s">true'</span>
        <span class="na">AccessPolicies</span><span class="pi">:</span>
          <span class="na">Version</span><span class="pi">:</span> <span class="s2">"</span><span class="s">2012-10-17"</span>
          <span class="na">Statement</span><span class="pi">:</span>
            <span class="pi">-</span>
              <span class="na">Effect</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Allow"</span>
              <span class="na">Principal</span><span class="pi">:</span>
                <span class="na">AWS</span><span class="pi">:</span>
                <span class="pi">-</span> <span class="kt">!Sub</span> <span class="s2">"</span><span class="s">arn:aws:iam::${AWS::AccountId}:root"</span>
              <span class="na">Action</span><span class="pi">:</span>
              <span class="pi">-</span> <span class="s2">"</span><span class="s">es:*"</span>
              <span class="na">Resource</span><span class="pi">:</span> <span class="s1">'</span><span class="s">*'</span>

  <span class="na">S3DocumentStoreBucket</span><span class="pi">:</span>
    <span class="na">Type</span><span class="pi">:</span> <span class="s">AWS::S3::Bucket</span>
    <span class="na">DependsOn</span><span class="pi">:</span> <span class="s">PermissionForS3ToInvokeLambda</span>
    <span class="na">Properties</span><span class="pi">:</span>
      <span class="na">BucketName</span><span class="pi">:</span> <span class="kt">!Sub</span> <span class="s2">"</span><span class="s">${AWS::StackName}-${AWS::AccountId}-documentstore"</span>
      <span class="na">NotificationConfiguration</span><span class="pi">:</span>
        <span class="na">LambdaConfigurations</span><span class="pi">:</span>
        <span class="pi">-</span>
          <span class="na">Event</span><span class="pi">:</span> <span class="s2">"</span><span class="s">s3:ObjectCreated:*"</span>
          <span class="na">Function</span><span class="pi">:</span> <span class="kt">!GetAtt</span> <span class="s">IndexDocumentLambda.Arn</span>
  
  <span class="na">PermissionForS3ToInvokeLambda</span><span class="pi">:</span>
    <span class="na">Type</span><span class="pi">:</span> <span class="s1">'</span><span class="s">AWS::Lambda::Permission'</span>
    <span class="na">Properties</span><span class="pi">:</span>
      <span class="na">Action</span><span class="pi">:</span> <span class="s1">'</span><span class="s">lambda:InvokeFunction'</span>
      <span class="na">FunctionName</span><span class="pi">:</span> <span class="kt">!GetAtt</span> <span class="s">IndexDocumentLambda.Arn</span>
      <span class="na">Principal</span><span class="pi">:</span> <span class="s1">'</span><span class="s">s3.amazonaws.com'</span>
      <span class="na">SourceAccount </span><span class="pi">:</span> <span class="kt">!Ref</span> <span class="s">AWS::AccountId</span>
      <span class="na">SourceArn</span><span class="pi">:</span>
        <span class="kt">!Join</span>
        <span class="pi">-</span> <span class="s1">'</span><span class="s">'</span>
        <span class="pi">-</span> <span class="pi">-</span> <span class="s2">"</span><span class="s">arn:aws:s3:::"</span>
          <span class="pi">-</span> <span class="kt">!Join</span>
                <span class="pi">-</span> <span class="s2">"</span><span class="s">-"</span>
                <span class="pi">-</span> <span class="pi">-</span> <span class="kt">!Ref</span> <span class="s">AWS::StackName</span>
                  <span class="pi">-</span> <span class="kt">!Ref</span> <span class="s">AWS::AccountId</span>
                  <span class="pi">-</span> <span class="s2">"</span><span class="s">documentstore"</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>リソースアクセスのためのロールとポリシーも記述されていますが、大まかに<code class="language-plaintext highlighter-rouge">Document Storage S3 ---&gt; Indexing Lambda ---&gt; Elasticsearch Service</code>の処理を記述します。
毎回PDF文章データが<code class="language-plaintext highlighter-rouge">S3DocumentStoreBucket</code>にアップされると、<code class="language-plaintext highlighter-rouge">IndexDocumentLambda</code>というラムダ関数が起動されます。</p>

<p>索引作成処理にはElasticsearchのエンドポイントにドキュメントを送信する処理ですが、下記になります[2]。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre></td><td class="rouge-code"><pre><span class="kd">function</span> <span class="nx">putDocumentToES</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">objURL</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Url </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">objURL</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">endpoint </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">esDomain</span><span class="p">.</span><span class="nx">endpoint</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">req</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AWS</span><span class="p">.</span><span class="nx">HttpRequest</span><span class="p">(</span><span class="nx">endpoint</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">attachKey</span> <span class="o">=</span> <span class="nx">key</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">?pipeline=attachment</span><span class="dl">'</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">bodyString</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
        <span class="dl">"</span><span class="s2">data</span><span class="dl">"</span><span class="p">:</span> <span class="nx">doc</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">filePath</span><span class="dl">"</span> <span class="p">:</span> <span class="nx">objURL</span>
    <span class="p">});</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">bodyString</span><span class="p">);</span>

    <span class="nx">req</span><span class="p">.</span><span class="nx">method</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">PUT</span><span class="dl">'</span><span class="p">;</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">path</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">,</span> <span class="nx">esDomain</span><span class="p">.</span><span class="nx">index</span><span class="p">,</span> <span class="nx">esDomain</span><span class="p">.</span><span class="nx">doctype</span><span class="p">,</span> <span class="nx">attachKey</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">reqPath </span><span class="dl">'</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">path</span><span class="p">);</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">region</span> <span class="o">=</span> <span class="nx">esDomain</span><span class="p">.</span><span class="nx">region</span><span class="p">;</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="nx">bodyString</span><span class="p">;</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="dl">'</span><span class="s1">presigned-expires</span><span class="dl">'</span><span class="p">]</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="dl">'</span><span class="s1">Host</span><span class="dl">'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">endpoint</span><span class="p">.</span><span class="nx">host</span><span class="p">;</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="dl">'</span><span class="s1">content-type</span><span class="dl">'</span><span class="p">]</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">application/json</span><span class="dl">'</span><span class="p">;</span>

    <span class="c1">// Sign the request (Sigv4)</span>
    <span class="kd">var</span> <span class="nx">signer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AWS</span><span class="p">.</span><span class="nx">Signers</span><span class="p">.</span><span class="nx">V4</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="dl">'</span><span class="s1">es</span><span class="dl">'</span><span class="p">);</span>
    <span class="nx">signer</span><span class="p">.</span><span class="nx">addAuthorization</span><span class="p">(</span><span class="nx">creds</span><span class="p">,</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">());</span>

    <span class="c1">// Post document to ES</span>
    <span class="kd">var</span> <span class="nx">send</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AWS</span><span class="p">.</span><span class="nx">NodeHttpClient</span><span class="p">();</span>
    <span class="nx">send</span><span class="p">.</span><span class="nx">handleRequest</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">httpResp</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">body</span> <span class="o">=</span> <span class="dl">''</span><span class="p">;</span>
        
        <span class="nx">httpResp</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">data</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">chunk</span><span class="p">)</span> <span class="p">{</span>
            
            <span class="nx">body</span> <span class="o">+=</span> <span class="nx">chunk</span><span class="p">;</span>
        <span class="p">});</span>
        <span class="nx">httpResp</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">end</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">chunk</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">completed</span><span class="dl">'</span><span class="p">);</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">body</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">httpResp</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Error: </span><span class="dl">'</span> <span class="o">+</span> <span class="nx">err</span><span class="p">);</span>
        <span class="nx">context</span><span class="p">.</span><span class="nx">fail</span><span class="p">();</span>
    <span class="p">});</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<h2 id="チャットボットへのインテグレーション">チャットボットへのインテグレーション</h2>
<p>LexへElasticsearchのをインテグレーションするために、ラムダ関数<code class="language-plaintext highlighter-rouge">BotFullfilmentLambda</code>を使います。</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
</pre></td><td class="rouge-code"><pre>  <span class="na">ESAccess</span><span class="pi">:</span>
    <span class="na">Type</span><span class="pi">:</span> <span class="s1">'</span><span class="s">AWS::IAM::Policy'</span>
    <span class="na">Properties</span><span class="pi">:</span>
      <span class="na">PolicyName</span><span class="pi">:</span> <span class="s">ESAccess</span>
      <span class="na">PolicyDocument</span><span class="pi">:</span>
        <span class="na">Version</span><span class="pi">:</span> <span class="s">2012-10-17</span>
        <span class="na">Statement</span><span class="pi">:</span>
          <span class="pi">-</span> 
            <span class="na">Effect</span><span class="pi">:</span> <span class="s">Allow</span>
            <span class="na">Action</span><span class="pi">:</span>
              <span class="pi">-</span> <span class="s">es:ESHttpGet</span>
              <span class="pi">-</span> <span class="s">es:ESHttpPost</span>
            <span class="na">Resource</span><span class="pi">:</span>
              <span class="kt">!Join</span>
              <span class="pi">-</span> <span class="s1">'</span><span class="s">'</span>
              <span class="pi">-</span> <span class="pi">-</span> <span class="kt">!GetAtt</span> <span class="s">ElasticsearchDomain.Arn</span>
                <span class="pi">-</span> <span class="s2">"</span><span class="s">/*"</span>
      <span class="na">Roles</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="kt">!Ref</span> <span class="s">BotFullfilmentLambdaExecutionRole</span>
  
  <span class="na">BotFullfilmentLambdaExecutionRole</span><span class="pi">:</span>
    <span class="na">Type</span><span class="pi">:</span> <span class="s2">"</span><span class="s">AWS::IAM::Role"</span>
    <span class="na">Properties</span><span class="pi">:</span>
      <span class="na">AssumeRolePolicyDocument</span><span class="pi">:</span>
        <span class="na">Version</span><span class="pi">:</span> <span class="s2">"</span><span class="s">2012-10-17"</span>
        <span class="na">Statement</span><span class="pi">:</span>
          <span class="pi">-</span>
            <span class="na">Effect</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Allow"</span>
            <span class="na">Principal</span><span class="pi">:</span>
              <span class="na">Service</span><span class="pi">:</span>
                <span class="pi">-</span> <span class="s2">"</span><span class="s">lambda.amazonaws.com"</span>
            <span class="na">Action</span><span class="pi">:</span>
              <span class="pi">-</span> <span class="s2">"</span><span class="s">sts:AssumeRole"</span>
      <span class="na">Path</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/"</span>
      <span class="na">ManagedPolicyArns</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s2">"</span><span class="s">arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"</span>

  <span class="na">BotFullfilmentLambda</span><span class="pi">:</span>
    <span class="na">Type</span><span class="pi">:</span> <span class="s2">"</span><span class="s">AWS::Lambda::Function"</span>
    <span class="na">Properties</span><span class="pi">:</span>
      <span class="na">Code</span><span class="pi">:</span>
        <span class="na">S3Bucket</span><span class="pi">:</span> <span class="s2">"</span><span class="s">aws-machine-learning-blog"</span>
        <span class="na">S3Key</span><span class="pi">:</span> <span class="s2">"</span><span class="s">artifacts/document-search-bot/lex-index.zip"</span>
      <span class="na">Description</span><span class="pi">:</span> <span class="s2">"</span><span class="s">This</span><span class="nv"> </span><span class="s">function</span><span class="nv"> </span><span class="s">will</span><span class="nv"> </span><span class="s">do</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">fullfillment</span><span class="nv"> </span><span class="s">of</span><span class="nv"> </span><span class="s">document</span><span class="nv"> </span><span class="s">search</span><span class="nv"> </span><span class="s">bot"</span>
      <span class="na">FunctionName</span><span class="pi">:</span> <span class="kt">!Sub</span> <span class="s2">"</span><span class="s">${AWS::StackName}-DocumentSearchBotFullfilment"</span>
      <span class="na">Handler</span><span class="pi">:</span> <span class="s">index.handler</span>
      <span class="na">MemorySize</span><span class="pi">:</span> <span class="m">256</span>
      <span class="na">Role</span><span class="pi">:</span> <span class="kt">!GetAtt</span> <span class="s">BotFullfilmentLambdaExecutionRole.Arn</span>
      <span class="na">Runtime</span><span class="pi">:</span> <span class="s2">"</span><span class="s">nodejs12.x"</span>
      <span class="na">Timeout</span><span class="pi">:</span> <span class="m">25</span>
      <span class="na">Environment</span><span class="pi">:</span>
        <span class="na">Variables</span><span class="pi">:</span>
            <span class="na">ESENDPOINT</span><span class="pi">:</span>
              <span class="kt">!Join</span>
                <span class="pi">-</span> <span class="s2">"</span><span class="s">"</span>
                <span class="pi">-</span> <span class="pi">-</span> <span class="s2">"</span><span class="s">https://"</span>
                  <span class="pi">-</span> <span class="kt">!GetAtt</span> <span class="s">ElasticsearchDomain.DomainEndpoint</span>
            <span class="na">AWSREGION</span><span class="pi">:</span> <span class="kt">!Ref</span> <span class="s">AWS::Region</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>インテグレーションの手順は下記になります。</p>

<ol>
  <li>Lexコンソール画面では、新しいチャットボットを作成する。</li>
  <li>言語を英語に設定する。</li>
  <li>英語言語でインテントを作成する。</li>
  <li>インテントの設定画面で「Codehooks」の項目に、<code class="language-plaintext highlighter-rouge">BotFullfilmentLambda</code>のARNを設定する。</li>
</ol>

<h2 id="考察">考察</h2>

<p>試すためには、数十冊の英文PDFをアップしました。
Lexコンソール画面からインテントの設定画面に移すと、「構築」ボタンを押し、「テスト」が可能になりました。
speech recognitionの要望を示すとボットは結果とダウンロードURLが返ります。</p>

<h3 id="メリット">メリット</h3>
<p>LexとElasticsearchのアプローチで音声による文章連想検索システムの構築は素早く終わらせました。
決まったインテントで音声認識したので、あまり誤差を拡大せず、正確に検索できました。
また、連想検索は検証されたElasticsearchのアプローチなので、正確な検索結果を取得でき、ユーザの満足感を向上できます。
なお、すべてサーバーレス形式なので、課金制度も柔軟になります。</p>

<h3 id="デメリット">デメリット</h3>
<p>一番目のデメリットは、アマゾンの内臓音声認識エンジンに好奇心を持っているのに、内臓エンジンに触れたいなら、エンジニアとしてアマゾンに入社するしかありません。
二番目は価格です。柔軟な課金制度ですが、しっかり強いシステムを構築するとどれぐらいかかるかみてみましょう。
今回のシステムの見積もりを作成しました。
Lex以外のサービスの見積は<a href="https://calculator.aws/#/estimate?nc2=pr&amp;id=4795298f02e0ff6301354c6582b451fe4e3b67c2">ここで</a>確認できます。
前提は、毎月1万冊程度、10万リクエストと想定しています。
ですので、Lexの単価は1音声リクエストあたり0.004ドルなので、毎月400ドルが課金されます。
上記の見積と合わせると、毎月1286ドルの課金量が発生します。
ElasticsearchとLexの課金量はかなりかかります。また、UltraWarmという大規模処理を補う機能を使うと、必ず毎月20万円以上が消費されると思います。</p>
<h1 id="おわりに">おわりに</h1>

<p>本稿では、アマゾンElasticsearchやLexなどを使ってすべてクラウドで<strong>音声認識による文書連想検索システム</strong>を実現しました。
1万文献かつ10万音声リクエスト規模のシステムです。</p>

<p>今回のデモは、コアの部分を実現したが、実に稼働するために、システムにセキュリティ機能、ログ処理、CloudWatch設定、例外処理などを追加するとなお良いです。
ユーザ認証はCognitoなどで実現すれば結構です。</p>

<h1 id="参考文献">参考文献</h1>

<ol class="bibliography"><li><span id="LexModel37:online"><i>LexModelsV2 — Boto3 Docs 1.18.6 documentation</i>. https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/lexv2-models.html.</span></li>
<li><span id="Buildado59:online">Jain, A., &amp; Kulkarni, R. <i>Build a document search bot using Amazon Lex and Amazon Elasticsearch Service | AWS Machine Learning Blog</i>. https://aws.amazon.com/jp/blogs/machine-learning/build-a-document-search-bot-using-amazon-lex-and-amazon-elasticsearch-service/.</span></li>
<li><span id="DeployaW32:online">Atoa, O., &amp; Strahan, B. <i>Deploy a Web UI for Your Chatbot  | AWS Machine Learning Blog</i>. https://aws.amazon.com/jp/blogs/machine-learning/deploy-a-web-ui-for-your-chatbot/.</span></li></ol>

            </div>

            <!-- Rating -->
            

            <!-- Post Date -->
            <p>
            <small>
                <span class="post-date"><time class="post-date" datetime="2021-07-24">24 Jul 2021</time></span>           
                
                </small>
            </p>

            <!-- Post Categories -->
            <div class="after-post-cats">
                <ul class="tags mb-4">
                    
                    
                    <li>
                        <a class="smoothscroll" href="https://wanted2.github.io/categories#Artificial-Intelligence">Artificial Intelligence</a>
                    </li>
                    
                    <li>
                        <a class="smoothscroll" href="https://wanted2.github.io/categories#Tiếng-Việt,-日本語">Tiếng Việt, 日本語</a>
                    </li>
                    
                </ul>
            </div>
            <!-- End Categories -->

            <!-- Post Tags -->
            <div class="after-post-tags">
                <ul class="tags">
                    
                    
                    <li>
                        <a class="smoothscroll" href="https://wanted2.github.io/tags#ai">#ai</a>
                    </li>
                    
                    <li>
                        <a class="smoothscroll" href="https://wanted2.github.io/tags#amazon-elasticsearch">#amazon elasticsearch</a>
                    </li>
                    
                    <li>
                        <a class="smoothscroll" href="https://wanted2.github.io/tags#amazon-lambda">#amazon lambda</a>
                    </li>
                    
                    <li>
                        <a class="smoothscroll" href="https://wanted2.github.io/tags#amazon-lex">#amazon lex</a>
                    </li>
                    
                    <li>
                        <a class="smoothscroll" href="https://wanted2.github.io/tags#amazon-s3">#amazon s3</a>
                    </li>
                    
                    <li>
                        <a class="smoothscroll" href="https://wanted2.github.io/tags#cloud">#cloud</a>
                    </li>
                    
                    <li>
                        <a class="smoothscroll" href="https://wanted2.github.io/tags#python">#python</a>
                    </li>
                    
                    <li>
                        <a class="smoothscroll" href="https://wanted2.github.io/tags#semantic-search">#semantic search</a>
                    </li>
                    
                    <li>
                        <a class="smoothscroll" href="https://wanted2.github.io/tags#文章連想検索">#文章連想検索</a>
                    </li>
                    
                    <li>
                        <a class="smoothscroll" href="https://wanted2.github.io/tags#音声認識">#音声認識</a>
                    </li>
                    
                </ul>
            </div>
            <!-- End Tags -->

            <!-- Prev/Next -->
            <div class="row PageNavigation d-flex justify-content-between font-weight-bold">
            
            <a class="prev d-block col-md-6" href="https://wanted2.github.io//bitbucket-pipelines-runners/"> &laquo; Bitbucket pipelines for small teams: Bitbucket Cloud or Self-hosted Runners?</a>
            
            
            <a class="next d-block col-md-6 text-lg-right" href="https://wanted2.github.io//python38-sys-exit/">Termination in Python &raquo; </a>
            
            <div class="clearfix"></div>
            </div>
            <!-- End Categories -->

        </div>
        <!-- End Post -->

    </div>
</div>
<!-- End Article
================================================== -->

<!-- Begin Comments
================================================== -->

    <div class="container">
        <div id="comments" class="row justify-content-center mb-5">
            <div class="col-md-8">
                <section class="disqus">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'caineng'; 
        var disqus_developer = 0;
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = window.location.protocol + '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>

            </div>
        </div>
    </div>

<!--End Comments
================================================== -->

<!-- Review with LD-JSON, adapt it for your needs if you like, but make sure you test the generated HTML source code first: 
https://search.google.com/structured-data/testing-tool/u/0/
================================================== -->

</div>


<!-- Bottom Alert Bar
================================================== -->
<div class="alertbar">
	<div class="container text-center">
		<span><img src="https://wanted2.github.io/assets/images/favicon.ico" alt="AiFi" style="max-height: 48px;" /> &nbsp; Never miss a <b>story</b> from us, subscribe to our newsletter</span>
        <form action="https://caineng.us20.list-manage.com/subscribe/post?u=76342d3d74a6807aac5aec0d7&id=b5645e19be" method="post" name="mc-embedded-subscribe-form" class="wj-contact-form validate" target="_blank" novalidate>
            <div class="mc-field-group">
            <input type="email" placeholder="Email" name="EMAIL" class="required email" id="mce-EMAIL" autocomplete="on" required>
            <input type="submit" value="Subscribe" name="subscribe" class="heart">
            </div>
        </form>
	</div>
</div>

    
</div>

<!-- Categories Jumbotron
================================================== -->
<div class="jumbotron fortags">
	<div class="d-md-flex h-100">
		<div class="col-md-4 transpdark align-self-center text-center h-100">
            <div class="d-md-flex align-items-center justify-content-center h-100">
                <h2 class="d-md-block align-self-center py-1 font-weight-light">Explore <span class="d-none d-md-inline">→</span></h2>
            </div>
		</div>
		<div class="col-md-8 p-5 align-self-center text-center">
            
            
                
                    <a class="mt-1 mb-1" href="https://wanted2.github.io/categories#Site-Reliable-Engineering">Site Reliable Engineering (14)</a>
                
                    <a class="mt-1 mb-1" href="https://wanted2.github.io/categories#Software-Engineering">Software Engineering (35)</a>
                
                    <a class="mt-1 mb-1" href="https://wanted2.github.io/categories#Computer-Vision">Computer Vision (5)</a>
                
                    <a class="mt-1 mb-1" href="https://wanted2.github.io/categories#Artificial-Intelligence">Artificial Intelligence (16)</a>
                
                    <a class="mt-1 mb-1" href="https://wanted2.github.io/categories#Tiếng-Việt,-日本語">Tiếng Việt, 日本語 (34)</a>
                
                    <a class="mt-1 mb-1" href="https://wanted2.github.io/categories#Project-Management">Project Management (34)</a>
                
            
            
		</div>
	</div>
</div>

<!-- Begin Footer
================================================== -->
<footer class="footer">
    <div class="container">
        <div class="row">
            <div class="col-md-6 col-sm-6 text-center text-lg-left">
                Copyright © 2022 AiFi 
            </div>
            <div class="col-md-6 col-sm-6 text-center text-lg-right">    
                <a target="_blank" href="https://www.wowthemes.net/mediumish-free-jekyll-template/">Mediumish Jekyll Theme</a> by WowThemes.net
            </div>
        </div>
    </div>
</footer>
<!-- End Footer
================================================== -->

</div> <!-- /.site-content -->

<!-- Scripts
================================================== -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>

<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>

<script src="https://wanted2.github.io/assets/js/mediumish.js"></script>


<script src="https://wanted2.github.io/assets/js/lazyload.js"></script>


<script src="https://wanted2.github.io/assets/js/ie10-viewport-bug-workaround.js"></script> 


<script id="dsq-count-scr" src="//caineng.disqus.com/count.js"></script>


</body>
</html>
