<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<link rel="icon" href="https://wanted2.github.io/assets/images/favicon.ico">

<title>Code audit processes and the new feature of Python 3.8 - sys.audit | AiFi</title>

 
    


<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Code audit processes and the new feature of Python 3.8 - sys.audit | AiFi</title>
<meta name="generator" content="Jekyll v4.2.1" />
<meta property="og:title" content="Code audit processes and the new feature of Python 3.8 - sys.audit" />
<meta name="author" content="tuan" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Auditing is actually a quality assurance feature. The purpose of audits is to identify and report problems, not to respond, prevent or act on them. If you are using Python 2.x or even Python 3.7, this feature may not be available. Calls like sys.audit and sys.addaudithook are only available from version 3.8. The new feature allows the audits to run at runtime level, or in other words, to keep track of changes in system calls and standard libraries while the application’s running. Two proposals that made this available are PEP 578[^4] and PEP 551[^3]. [^3]: PEP 551 - Security transparency in the Python runtime - Python.org [^4]: PEP 578 – Python Runtime Audit Hooks | Python.org" />
<meta property="og:description" content="Auditing is actually a quality assurance feature. The purpose of audits is to identify and report problems, not to respond, prevent or act on them. If you are using Python 2.x or even Python 3.7, this feature may not be available. Calls like sys.audit and sys.addaudithook are only available from version 3.8. The new feature allows the audits to run at runtime level, or in other words, to keep track of changes in system calls and standard libraries while the application’s running. Two proposals that made this available are PEP 578[^4] and PEP 551[^3]. [^3]: PEP 551 - Security transparency in the Python runtime - Python.org [^4]: PEP 578 – Python Runtime Audit Hooks | Python.org" />
<meta property="og:site_name" content="AiFi" />
<meta property="og:image" content="https://upload.wikimedia.org/wikipedia/commons/thumb/f/f8/Python_logo_and_wordmark.svg/800px-Python_logo_and_wordmark.svg.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-07-17T00:00:00+09:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://upload.wikimedia.org/wikipedia/commons/thumb/f/f8/Python_logo_and_wordmark.svg/800px-Python_logo_and_wordmark.svg.png" />
<meta property="twitter:title" content="Code audit processes and the new feature of Python 3.8 - sys.audit" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"tuan"},"dateModified":"2021-07-17T00:00:00+09:00","datePublished":"2021-07-17T00:00:00+09:00","description":"Auditing is actually a quality assurance feature. The purpose of audits is to identify and report problems, not to respond, prevent or act on them. If you are using Python 2.x or even Python 3.7, this feature may not be available. Calls like sys.audit and sys.addaudithook are only available from version 3.8. The new feature allows the audits to run at runtime level, or in other words, to keep track of changes in system calls and standard libraries while the application’s running. Two proposals that made this available are PEP 578[^4] and PEP 551[^3]. [^3]: PEP 551 - Security transparency in the Python runtime - Python.org [^4]: PEP 578 – Python Runtime Audit Hooks | Python.org","headline":"Code audit processes and the new feature of Python 3.8 - sys.audit","image":"https://upload.wikimedia.org/wikipedia/commons/thumb/f/f8/Python_logo_and_wordmark.svg/800px-Python_logo_and_wordmark.svg.png","mainEntityOfPage":{"@type":"WebPage","@id":"/https://wanted2.github.io/python-38-sys-audit/"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"/https://wanted2.github.io/assets/images/favicon.ico"},"name":"tuan"},"url":"/https://wanted2.github.io/python-38-sys-audit/"}</script>
<!-- End Jekyll SEO tag -->


<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    
<link href="https://wanted2.github.io/assets/css/screen.css" rel="stylesheet">

<link href="https://wanted2.github.io/assets/css/main.css" rel="stylesheet">

<script src="https://wanted2.github.io/assets/js/jquery.min.js"></script>
<script src="https://kit.fontawesome.com/d0b91d895e.js" crossorigin="anonymous"></script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        processEscapes: true
    }
    });
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript" crossorigin="anonymous"></script>
<script src="https://d3js.org/d3.v4.js" crossorigin="anonymous"></script>
<!-- <script src="https://bl.ocks.org/mbostock/raw/4061502/0a200ddf998aa75dfdb1ff32e16b680a15e5cb01/box.js" crossorigin="anonymous"></script> -->
</head>


<body class="layout-post">
	<!-- defer loading of font and font awesome -->
	<noscript id="deferred-styles">
		<link href="https://fonts.googleapis.com/css?family=Righteous%7CMerriweather:300,300i,400,400i,700,700i" rel="stylesheet">
		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
	</noscript>


<!-- Begin Menu Navigation
================================================== -->
<nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top mediumnavigation nav-down">

    <div class="container pr-0">

    <!-- Begin Logo -->
    <a class="navbar-brand" href="https://wanted2.github.io/">
    <img src="https://wanted2.github.io/assets/images/favicon.ico" alt="AiFi">
    </a>
    <!-- End Logo -->

    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarMediumish" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarMediumish">

        <!-- Begin Menu -->

            <ul class="navbar-nav ml-auto">

                
                <li class="nav-item">
                
                <a class="nav-link" href="https://wanted2.github.io/">Blog</a>
                </li>

                <li class="nav-item">
                <a class="nav-link" href="https://wanted2.github.io/about">About</a>
                </li>

                <li class="nav-item">
                <a class="nav-link" href="https://wanted2.github.io/projects">Projects</a>
                </li>

                <li class="nav-item">
                    <a class="nav-link" href="https://wanted2.github.io/service">Services</a>
                </li>

                <!-- <li class="nav-item">
                <a target="_blank" class="nav-link" href="https://bootstrapstarter.com/bootstrap-templates/template-mediumish-bootstrap-jekyll/"> Docs</a>
                </li>

                <li class="nav-item">
                <a target="_blank" class="nav-link" href="https://www.wowthemes.net/themes/mediumish-wordpress/"><i class="fab fa-wordpress-simple"></i> WP Version</a>
                </li>

                <li class="nav-item">
                <a target="_blank" class="nav-link" href="https://www.wowthemes.net/themes/mediumish-ghost/"><i class="fab fa-snapchat-ghost"></i> Ghost Version</a>
                </li>

                <li class="nav-item">
                <a target="_blank" class="nav-link" href="https://github.com/wowthemesnet/mediumish-theme-jekyll"><i class="fab fa-github"></i> Fork on Github</a>
                </li> -->

                <!-- <script src="https://wanted2.github.io/assets/js/lunr.js"></script>


<style>
    .lunrsearchresult .title {color: #d9230f;}
    .lunrsearchresult .url {color: silver;}
    .lunrsearchresult a {display: block; color: #777;}
    .lunrsearchresult a:hover, .lunrsearchresult a:focus {text-decoration: none;}
    .lunrsearchresult a:hover .title {text-decoration: underline;}
</style>


<form class="bd-search" onSubmit="return lunr_search(document.getElementById('lunrsearch').value);">
    <input type="text" class="form-control text-small launch-modal-search" id="lunrsearch" name="q" maxlength="255" value="" placeholder="Type and enter..."/>
</form>

<div id="lunrsearchresults">
    <ul></ul>
</div>

<script src="https://wanted2.github.io/assets/js/lunrsearchengine.js"></script> -->

            </ul>

        <!-- End Menu -->

    </div>

    </div>
</nav>
<!-- End Navigation
================================================== -->

<div class="site-content">

<div class="container">

<!-- Site Title
================================================== -->
<div class="mainheading">
    <h1 class="sitetitle">AiFi</h1>
    <p class="lead">
        An AI Engineer's blog (This is a staging site, so the content may be imprecise, refer to official AiFi)
    </p>
</div>

<!-- Content
================================================== -->
<div class="main-content">
    <!-- Begin Article
================================================== -->
<div class="container">
    <div class="row">

        <!-- Post Share -->
        <div class="col-md-2 pl-0">
            <div class="share sticky-top sticky-top-offset">
    <p>
        Share
    </p>
    <ul>
        <li class="ml-1 mr-1">
            <a target="_blank" href="https://twitter.com/intent/tweet?text=Code audit processes and the new feature of Python 3.8 - sys.audit&url=https://wanted2.github.io/python-38-sys-audit/" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                <i class="fab fa-twitter"></i>
            </a>
        </li>

        <li class="ml-1 mr-1">
            <a target="_blank" href="https://facebook.com/sharer.php?u=https://wanted2.github.io/python-38-sys-audit/" onclick="window.open(this.href, 'facebook-share', 'width=550,height=435');return false;">
                <i class="fab fa-facebook-f"></i>
            </a>
        </li>

        <li class="ml-1 mr-1">
            <a target="_blank" href="https://www.linkedin.com/shareArticle?mini=true&url=https://wanted2.github.io/python-38-sys-audit/" onclick="window.open(this.href, 'width=550,height=435');return false;">
                <i class="fab fa-linkedin-in"></i>
            </a>
        </li>

        <li class="ml-1 mr-1">
            <a target="_blank" href="mailto:?subject=Code audit processes and the new feature of Python 3.8 - sys.audit&body=https://wanted2.github.io/python-38-sys-audit/" onclick="window.open(this.href, 'width=550,height=435');return false;">
                <i class="fas fa-envelope"></i>
            </a>
        </li>

    </ul>
    
    <div class="sep">
    </div>
    <ul>
        <li>
        <a class="small smoothscroll" href="#disqus_thread"></a>
        </li>
    </ul>
    
    
    <div class="sep">

    </div>
    <ul>
        <li class="small">
        2213
     words</li>
        <li class="small">12 minutes</li>
    </ul>
</div>

        </div>

        <!-- Post -->
        

        <div class="col-md-9 flex-first flex-md-unordered">
            <div class="mainheading">

                <!-- Author Box -->
                
                <div class="row post-top-meta">
                    <div class="col-xs-12 col-md-2 col-lg-2 text-left mb-4 mb-md-0">
                        
                        <img class="author-thumb" src="https://wanted2.github.io/assets/images/favicon.png" alt="AiFi">
                        
                    </div>
                    <div class="col-xs-12 col-md-10 col-lg-10 text-right">
                        <a target="_blank" class="link-dark" href="">AiFi</a>
                        <!-- <a target="_blank" href="" class="btn follow">Follow</a> -->
                        <!-- LikeBtn.com BEGIN -->
                        <span class="likebtn-wrapper" 
                            data-site_id=""
                            data-theme="custom" 
                            data-icon_l_url="/assets/images/OK_EM.png" 
                            data-icon_l_url_v="/assets/images/OK_EM_clicked.png" 
                            data-identifier="/python-38-sys-audit/" 
                            data-show_like_label="false" 
                            data-like_enabled="false" 
                            data-dislike_enabled="false" 
                            data-icon_dislike_show="false" 
                            data-voting_cancelable="false" 
                            data-counter_show="true"
                            data-counter_frmt="comma"></span>
                        <script>(function(d,e,s){if(d.getElementById("likebtn_wjs"))return;a=d.createElement(e);m=d.getElementsByTagName(e)[0];a.async=1;a.id="likebtn_wjs";a.src=s;m.parentNode.insertBefore(a, m)})(document,"script","//w.likebtn.com/js/w/widget.js");</script>
                        <!-- LikeBtn.com END -->
                        <span class="author-description"></span>
                    </div>
                </div>
                

                <!-- Post Title -->
                <h1 class="posttitle">Code audit processes and the new feature of Python 3.8 - sys.audit</h1>

            </div>

            <!-- Adsense if enabled from _config.yml (change your pub id and slot) -->
            
            <!-- End Adsense -->

            <!-- Post Featured Image -->
            

            
            <img class="featured-image img-fluid lazyimg" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAMAAAACCAQAAAA3fa6RAAAADklEQVR42mNkAANGCAUAACMAA2w/AMgAAAAASUVORK5CYII=" data-src="https://upload.wikimedia.org/wikipedia/commons/thumb/f/f8/Python_logo_and_wordmark.svg/800px-Python_logo_and_wordmark.svg.png" alt="Code audit processes and the new feature of Python 3.8 - sys.audit">
            

            
            <!-- End Featured Image -->

            <!-- Post Content -->
            <div class="article-post">
                <!-- Toc if any -->
                
                    
                    <div class="toc mt-4 mb-4 lead">
                        <h3 class="font-weight-bold">Summary</h3>
                        <ul>
  <li><a href="#overview-of-technical-audits">Overview of technical audits</a>
    <ul>
      <li><a href="#code-review-vs-code-audit">Code review vs. code audit</a></li>
      <li><a href="#general-audit-aspects-and-tools">General audit aspects and tools</a>
        <ul>
          <li><a href="#code-management">Code management</a></li>
          <li><a href="#architectures">Architectures</a>
            <ul>
              <li><a href="#integrability">Integrability</a></li>
              <li><a href="#deployment-and-delivery">Deployment and delivery</a></li>
              <li><a href="#maintenance-and-incident-responses">Maintenance and incident responses</a></li>
            </ul>
          </li>
          <li><a href="#coding-best-practices">Coding best practices</a>
            <ul>
              <li><a href="#using-code-analysis-tools">Using code analysis tools</a></li>
              <li><a href="#tips-to-improve-code-quality">Tips to improve code quality</a></li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#python-audit-tools">Python audit tools</a>
    <ul>
      <li><a href="#proposals-pep-578-and-pep-551">Proposals PEP 578 and PEP 551</a></li>
      <li><a href="#sysaudit-and-sysaddaudithook"><code class="language-plaintext highlighter-rouge">sys.audit</code> and <code class="language-plaintext highlighter-rouge">sys.addaudithook</code></a>
        <ul>
          <li><a href="#native-c-interface">Native C interface</a></li>
          <li><a href="#standard-interface">Standard interface</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#conclusion">Conclusion</a></li>
  <li><a href="#references">References</a></li>
</ul>
                    </div>
                
                <!-- End Toc -->
                <p><strong>Auditing</strong> is actually a quality assurance feature.
The purpose of audits is to identify and report problems, not to respond, prevent or act on them.
If you are using Python 2.x or even Python 3.7, this feature may not be available.
Calls like <code class="language-plaintext highlighter-rouge">sys.audit</code> and <code class="language-plaintext highlighter-rouge">sys.addaudithook</code> are only available from version 3.8.
The new feature allows the audits to run at runtime level, or in other words, to keep track of changes in system calls and standard libraries while the application’s running.
Two proposals that made this available are PEP 578[^4] and PEP 551[^3].
[^3]: <a href="https://www.python.org/dev/peps/pep-0551/">PEP 551 - Security transparency in the Python runtime - Python.org</a>
[^4]: <a href="https://www.python.org/dev/peps/pep-0578">PEP 578 – Python Runtime Audit Hooks | Python.org</a>
<!--more--></p>

<h1 id="overview-of-technical-audits">Overview of technical audits</h1>

<h2 id="code-review-vs-code-audit">Code review vs. code audit</h2>

<p>First of all, <strong>code audit</strong> differs from code reviews.
First, while code reviews can be done by internal teams, each member reviews code of and focus on the specific part of the project, <strong>code audit</strong> is relevant to the whole project, a <code class="language-plaintext highlighter-rouge">big picture</code> and <strong>must be done objectively (often done by an outsider who is not a member of the project, or even from another company)</strong>.
Second, code reviews can be done by only reading and find suspicious pieces in the code, but <strong>code audit requires to see the product running in actions</strong>.
Therefore, to support the audit, language tools, and utilities to ascertain the changes made by the programs during the run is helpful.</p>

<h2 id="general-audit-aspects-and-tools">General audit aspects and tools</h2>

<p>There are several aspects to assess when auditing a software project.</p>

<h3 id="code-management">Code management</h3>

<p>Most software projects adopt some kinds of code management tools like Git and Mercurial to reduce operation mistakes.</p>

<p>Check your target projects if they have their own code repositories and governance policies for code management.
Some items to include in the checklist:</p>

<ul>
  <li>Branch naming convention</li>
  <li>Workflow like <a href="https://www.atlassian.com/git/tutorials/comparing-workflows/gitflow-workflow">Gitflow</a> to determine the process of creating PR, merging, .etc.</li>
  <li>Release management: Git <a href="https://docs.github.com/en/rest/reference/git#tags">tags</a> systems may help to version different releases in project lifetime.</li>
  <li>and any recommendations that help to improve code management.</li>
</ul>

<h3 id="architectures">Architectures</h3>

<p>Software products take many forms: desktop applications, mobile apps, websites, infrastructures, and even combinations to make a far complicated system.
But whatever the forms they take, they will have architectural choices.</p>

<h4 id="integrability">Integrability</h4>
<p>A product can be a mixture of many components: a website written with Django framework with PostgresSQL.
First, please pay attention to the <strong>compatibilities among components</strong>: are all versions work well together? Are all of them well-tested together (system test or integration tests are sufficient)?</p>

<h4 id="deployment-and-delivery">Deployment and delivery</h4>
<p><em>How is the product (system) deployed and delivered to the customer?</em></p>

<p>Please pay attention to the deployment process.
If the project has a continuous mechanism to deliver outcomes to the customer, it should make everything’s smoother.
Especially if CI/CD processes have not been well-tested, then it should be good advice to construct such a pipeline.
Container systems like Docker or Kubernetes are helpful.</p>

<p>Then, it’s time to check whether the README file contains all the necessary elements:</p>

<ul>
  <li>instructions for configuration,</li>
  <li>instructions for installation,</li>
  <li>a user’s manual,</li>
  <li>a manifest file (with an attached list of files),</li>
  <li>information on copyrights and licenses,</li>
  <li>contact details for the distributors and developers,</li>
  <li>known bugs and malfunctions,</li>
  <li>a problem-solving section,</li>
  <li>a changelog (for developers).</li>
</ul>

<h4 id="maintenance-and-incident-responses">Maintenance and incident responses</h4>

<p>The system may be down for many reasons: operating mistakes, system errors, human errors, and so on.
Does the project has such a mechanism to report and respond to the errors?
An error tracking tool like <a href="https://www.bugsnag.com/">Bugsnag</a> is good advice.</p>

<h3 id="coding-best-practices">Coding best practices</h3>

<h4 id="using-code-analysis-tools">Using code analysis tools</h4>

<p>Static code analyzers like linting tools are helpful to detect early bugs, bottlenecks, performance issues, security vulnerabilities, and threats connected with maintaining the application.</p>

<h4 id="tips-to-improve-code-quality">Tips to improve code quality</h4>

<p><strong>Code reviews</strong> between team members (developers) help to detect early problems.
<strong>Using githooks</strong> can enforce your local development.
<strong>Standardize the configurations and formats</strong> among team members like IDE configurations can prevent several human errors.
Finally, remember to <strong>share knowledge</strong> among the team.</p>

<h1 id="python-audit-tools">Python audit tools</h1>

<h2 id="proposals-pep-578-and-pep-551">Proposals PEP 578 and PEP 551</h2>

<p>Since code audit is inevitable in software development, the Python programming language also has its own tools to do the job.
Remember that code audit differs from code reviews in the way that code audit reviews the <strong>running</strong> system!
Then if it’s not running, this is not audit.</p>

<p>In this post, we focus on the new features for runtime audit: proposals PEP 578 [^4] and PEP 551[^3].
These proposals were made available only from Python 3.8.
PEP 578 was only a part of PEP 551, which concerns the <strong>security transparency</strong> of Python programs: the lack of internal audits leads to the fact that many threats can bypass audits.
Python up to 3.7 in isolation could manage to audit all events in codes.
However, no runtime events have been captured, and this led to a poor audit.
Defenders have a need to audit specific uses of the Python programming language in order to detect abnormal or malicious usage. 
With PEP 578, the Python runtime gains the ability to provide this. 
The aim of this PEP is to assist system administrators with deploying a security-transparent version of the Python programming language that can integrate with their existing auditing and protection systems.</p>

<h2 id="sysaudit-and-sysaddaudithook"><code class="language-plaintext highlighter-rouge">sys.audit</code> and <code class="language-plaintext highlighter-rouge">sys.addaudithook</code></h2>

<p>Runtime audithooks [^4] comes with two different APIs: CPython and standard way.
You can use <code class="language-plaintext highlighter-rouge">sys.audit/sys.addaudithooks</code> in Python code and <code class="language-plaintext highlighter-rouge">PySys_Audit/PySys_AddAuditHook</code> in native C code PEP 578<sup id="fnref:6" role="doc-noteref"><a href="#fn:6" class="footnote" rel="footnote">1</a></sup>.
The backport to Python 3.7 and older versions can be found in a third-party <code class="language-plaintext highlighter-rouge">sysaudit</code><sup id="fnref:5" role="doc-noteref"><a href="#fn:5" class="footnote" rel="footnote">2</a></sup>
A list of <strong>auditable events</strong> can be found in <sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">3</a></sup>.
Some discussions on bypassing audit features in Python 3.8 can be found in<sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote" rel="footnote">4</a></sup>.</p>

<h3 id="native-c-interface">Native C interface</h3>

<p>If you want native audits, you may need to re-compile the <code class="language-plaintext highlighter-rouge">python</code> binary.
An example is the <a href="https://github.com/zooba/spython/tree/master/NetworkPrompt">NetworkPromtHook example</a>.</p>

<p>We will write an example <code class="language-plaintext highlighter-rouge">spython.c</code>:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;Python.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;opcode.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;locale.h&gt;</span><span class="cp">
</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">my_hook</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">event</span><span class="p">,</span> <span class="n">PyObject</span><span class="o">*</span> <span class="n">args</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span> <span class="n">userData</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* Only care about 'socket.' events */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="s">"socket."</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">PyObject</span><span class="o">*</span> <span class="n">msg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="cm">/* So yeah, I'm very lazily using PyTuple_GET_ITEM here.
       Not best practice! PyArg_ParseTuple is much better! */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="s">"socket.getaddrinfo"</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">PyUnicode_FromFormat</span><span class="p">(</span><span class="s">"WARNING: Attempt to resolve %S:%S"</span><span class="p">,</span>
            <span class="n">PyTuple_GET_ITEM</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">PyTuple_GET_ITEM</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="s">"socket.connect"</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">PyObject</span><span class="o">*</span> <span class="n">addro</span> <span class="o">=</span> <span class="n">PyTuple_GET_ITEM</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">PyUnicode_FromFormat</span><span class="p">(</span><span class="s">"WARNING: Attempt to connect %S:%S"</span><span class="p">,</span>
            <span class="n">PyTuple_GET_ITEM</span><span class="p">(</span><span class="n">addro</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">PyTuple_GET_ITEM</span><span class="p">(</span><span class="n">addro</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">PyUnicode_FromFormat</span><span class="p">(</span><span class="s">"WARNING: %s (event not handled)"</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"%s. Continue [Y/n]</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">PyUnicode_AsUTF8</span><span class="p">(</span><span class="n">msg</span><span class="p">));</span>
    <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">fgetc</span><span class="p">(</span><span class="n">stdin</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="sc">'n'</span> <span class="o">||</span> <span class="n">ch</span> <span class="o">==</span> <span class="sc">'N'</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">while</span> <span class="p">(</span><span class="n">ch</span> <span class="o">!=</span> <span class="sc">'\n'</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ch</span> <span class="o">=</span> <span class="n">fgetc</span><span class="p">(</span><span class="n">stdin</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#ifdef MS_WINDOWS
</span><span class="kt">int</span>
<span class="nf">wmain</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">wchar_t</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PySys_AddAuditHook</span><span class="p">(</span><span class="n">my_hook</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">Py_Main</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else
</span><span class="kt">int</span>
<span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PySys_AddAuditHook</span><span class="p">(</span><span class="n">my_hook</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">_Py_UnixMain</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>In Windows, this requires Visual Studio C, and compilation can be done:</p>

<div class="language-bat highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="rouge-code"><pre>@setlocal
@echo <span class="na">off</span>
<span class="k">if</span> <span class="ow">not</span> <span class="ow">defined</span> <span class="kd">PYTHONDIR</span> <span class="nb">echo</span> <span class="kd">PYTHONDIR</span> <span class="kd">must</span> <span class="kd">be</span> <span class="kd">set</span> <span class="kd">before</span> <span class="kd">building</span> <span class="o">&amp;&amp;</span> <span class="k">exit</span> <span class="na">/B </span><span class="m">1</span>
<span class="k">if</span> <span class="ow">exist</span> <span class="s2">"</span><span class="nv">%PYTHONDIR%</span><span class="s2">\PCbuild"</span> <span class="o">(</span>
    <span class="kd">set</span> _PYTHONINCLUDE<span class="o">=</span><span class="na">-I</span><span class="s2">"</span><span class="nv">%PYTHONDIR%</span><span class="s2">\PC"</span> <span class="na">-I</span><span class="s2">"</span><span class="nv">%PYTHONDIR%</span><span class="s2">\include"</span>
    <span class="k">if</span> <span class="s2">"</span><span class="nv">%VSCMD_ARG_TGT_ARCH%</span><span class="s2">"</span> <span class="o">==</span> <span class="s2">"x86"</span> <span class="o">(</span>
        <span class="kd">set</span> _PYTHONLIB<span class="o">=</span><span class="nv">%PYTHONDIR%</span>\PCbuild\win32
    <span class="o">)</span> <span class="k">else</span> <span class="o">(</span>
        <span class="kd">set</span> _PYTHONLIB<span class="o">=</span><span class="nv">%PYTHONDIR%</span>\PCbuild\amd64
    <span class="o">)</span>
<span class="o">)</span> <span class="k">else</span> <span class="o">(</span>
    <span class="kd">set</span> _PYTHONINCLUDE<span class="o">=</span><span class="na">-I</span><span class="s2">"</span><span class="nv">%PYTHONDIR%</span><span class="s2">\include"</span>
    <span class="kd">set</span> _PYTHONLIB<span class="o">=</span><span class="nv">%PYTHONDIR%</span>\libs
<span class="o">)</span>

<span class="k">if</span> <span class="ow">exist</span> <span class="s2">"</span><span class="nv">%_PYTHONLIB%</span><span class="s2">\python_d.exe"</span> <span class="o">(</span>
    <span class="kd">set</span> _MD<span class="o">=</span><span class="na">-MDd
</span><span class="o">)</span> <span class="k">else</span> <span class="o">(</span>
    <span class="kd">set</span> _MD<span class="o">=</span><span class="na">-MD
</span><span class="o">)</span>

@echo <span class="na">on</span>
@if <span class="ow">not</span> <span class="ow">exist</span> <span class="kd">obj</span> <span class="nb">mkdir</span> <span class="kd">obj</span>
<span class="kd">cl</span> <span class="na">-nologo </span><span class="nv">%_MD%</span> <span class="na">-c </span><span class="kd">spython</span>.c <span class="na">-Foobj</span>\spython.obj <span class="na">-Iobj -Zi -O</span><span class="m">2</span> <span class="nv">%_PYTHONINCLUDE%</span>
@if <span class="ow">errorlevel</span> <span class="m">1</span> <span class="k">exit</span> <span class="na">/B </span><span class="nv">%ERRORLEVEL%</span>
<span class="kd">link</span> <span class="na">/nologo </span><span class="kd">obj</span>\spython.obj <span class="na">/out</span><span class="nl">:spython</span>.exe <span class="na">/debug</span><span class="nl">:FULL</span> <span class="na">/pdb</span><span class="nl">:spython</span>.pdb <span class="na">/libpath</span>:<span class="s2">"</span><span class="nv">%_PYTHONLIB%</span><span class="s2">"</span>
@if <span class="ow">errorlevel</span> <span class="m">1</span> <span class="k">exit</span> <span class="na">/B </span><span class="nv">%ERRORLEVEL%</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Save this bat script as <code class="language-plaintext highlighter-rouge">make.cmd</code> and run it in a VC console to compile <code class="language-plaintext highlighter-rouge">spython.exe</code>.
Then we can confirm the audit is in effect:</p>

<p><img src="/assets/images/spython.PNG" alt="" /></p>

<h3 id="standard-interface">Standard interface</h3>

<p>To do audits in pure Python language, we can use <code class="language-plaintext highlighter-rouge">sys.audit/sys.addaudithook</code> as follows:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">sys</span>

<span class="k">def</span> <span class="nf">my_hook</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="c1"># Only care about 'socket.' events
</span>    <span class="k">if</span> <span class="ow">not</span> <span class="n">event</span><span class="p">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">"socket."</span><span class="p">):</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="s">"socket.getaddrinfo"</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s">"WARNING: Attempt to resolve {}:{}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">event</span> <span class="o">==</span> <span class="s">"socket.connect"</span><span class="p">:</span>
        <span class="n">addro</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s">"WARNING: Attempt to connect {}:{}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">addro</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">addro</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s">"WARNING: {} (event not handled)"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

    <span class="n">ch</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="n">msg</span> <span class="o">+</span> <span class="s">". Continue [Y/n]</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="s">'n'</span> <span class="ow">or</span> <span class="n">ch</span> <span class="o">==</span> <span class="s">'N'</span><span class="p">:</span>
        <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">sys</span><span class="p">.</span><span class="n">addaudithook</span><span class="p">(</span><span class="n">my_hook</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>, then confirm the effects similarly.</p>

<h1 id="conclusion">Conclusion</h1>

<p>This article introduced two important features in a software project.
The first part showed an overview of code audit in practice.
The second part discussed a new audit feature in the Python programming language: <code class="language-plaintext highlighter-rouge">sys.audit/PySys_Audit</code>.</p>

<p>Although this feature is new in the Python programming language but the merit of capturing runtime events can be helpful.
Benchmark in PEP 578 [^4] showed that adding this audit did not change the performance or cost then it is nice to have this in your project.</p>
<h1 id="references">References</h1>

<ol class="bibliography"></ol>
<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:6" role="doc-endnote">
      <p><a href="https://docs.python.org/3/library/sys.html">sys - System-specific parameters and functions - Python 3.9.6 documentation</a> <a href="#fnref:6" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:5" role="doc-endnote">
      <p><a href="https://sysaudit.readthedocs.io/en/latest/">sysaudit – sysaudit documentation</a> <a href="#fnref:5" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:1" role="doc-endnote">
      <p><a href="https://docs.python.org/3/library/audit_events.html">Audit events table - Python 3.9.6 documentation</a> <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:2" role="doc-endnote">
      <p><a href="https://daddycocoaman.dev/posts/bypassing-python38-audit-hooks-part-1/">Bypassing Python3.8 Audit Hooks [Part 1] · daddycocoaman</a> <a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>

            </div>

            <!-- Rating -->
            

            <!-- Post Date -->
            <p>
            <small>
                <span class="post-date"><time class="post-date" datetime="2021-07-17">17 Jul 2021</time></span>           
                
                </small>
            </p>

            <!-- Post Categories -->
            <div class="after-post-cats">
                <ul class="tags mb-4">
                    
                    
                    <li>
                        <a class="smoothscroll" href="https://wanted2.github.io/categories#Artificial-Intelligence">Artificial Intelligence</a>
                    </li>
                    
                    <li>
                        <a class="smoothscroll" href="https://wanted2.github.io/categories#Project-Management">Project Management</a>
                    </li>
                    
                    <li>
                        <a class="smoothscroll" href="https://wanted2.github.io/categories#Software-Engineering">Software Engineering</a>
                    </li>
                    
                </ul>
            </div>
            <!-- End Categories -->

            <!-- Post Tags -->
            <div class="after-post-tags">
                <ul class="tags">
                    
                    
                    <li>
                        <a class="smoothscroll" href="https://wanted2.github.io/tags#PEP-578">#PEP 578</a>
                    </li>
                    
                    <li>
                        <a class="smoothscroll" href="https://wanted2.github.io/tags#code-audit">#code audit</a>
                    </li>
                    
                    <li>
                        <a class="smoothscroll" href="https://wanted2.github.io/tags#programming">#programming</a>
                    </li>
                    
                    <li>
                        <a class="smoothscroll" href="https://wanted2.github.io/tags#project-management">#project management</a>
                    </li>
                    
                    <li>
                        <a class="smoothscroll" href="https://wanted2.github.io/tags#python">#python</a>
                    </li>
                    
                    <li>
                        <a class="smoothscroll" href="https://wanted2.github.io/tags#runtime-audit">#runtime audit</a>
                    </li>
                    
                    <li>
                        <a class="smoothscroll" href="https://wanted2.github.io/tags#security-features">#security features</a>
                    </li>
                    
                    <li>
                        <a class="smoothscroll" href="https://wanted2.github.io/tags#system-audit">#system audit</a>
                    </li>
                    
                    <li>
                        <a class="smoothscroll" href="https://wanted2.github.io/tags#system-security">#system security</a>
                    </li>
                    
                </ul>
            </div>
            <!-- End Tags -->

            <!-- Prev/Next -->
            <div class="row PageNavigation d-flex justify-content-between font-weight-bold">
            
            <a class="prev d-block col-md-6" href="https://wanted2.github.io//python-chain-of-responsibility/"> &laquo; Pythonによる責任の連鎖</a>
            
            
            <a class="next d-block col-md-6 text-lg-right" href="https://wanted2.github.io//xops/">Tản mạn về XOps &raquo; </a>
            
            <div class="clearfix"></div>
            </div>
            <!-- End Categories -->

        </div>
        <!-- End Post -->

    </div>
</div>
<!-- End Article
================================================== -->

<!-- Begin Comments
================================================== -->

    <div class="container">
        <div id="comments" class="row justify-content-center mb-5">
            <div class="col-md-8">
                <section class="disqus">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'caineng'; 
        var disqus_developer = 0;
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = window.location.protocol + '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>

            </div>
        </div>
    </div>

<!--End Comments
================================================== -->

<!-- Review with LD-JSON, adapt it for your needs if you like, but make sure you test the generated HTML source code first: 
https://search.google.com/structured-data/testing-tool/u/0/
================================================== -->

</div>


<!-- Bottom Alert Bar
================================================== -->
<div class="alertbar">
	<div class="container text-center">
		<span><img src="https://wanted2.github.io/assets/images/favicon.ico" alt="AiFi" style="max-height: 48px;" /> &nbsp; Never miss a <b>story</b> from us, subscribe to our newsletter</span>
        <form action="https://caineng.us20.list-manage.com/subscribe/post?u=76342d3d74a6807aac5aec0d7&id=b5645e19be" method="post" name="mc-embedded-subscribe-form" class="wj-contact-form validate" target="_blank" novalidate>
            <div class="mc-field-group">
            <input type="email" placeholder="Email" name="EMAIL" class="required email" id="mce-EMAIL" autocomplete="on" required>
            <input type="submit" value="Subscribe" name="subscribe" class="heart">
            </div>
        </form>
	</div>
</div>

    
</div>

<!-- Categories Jumbotron
================================================== -->
<div class="jumbotron fortags">
	<div class="d-md-flex h-100">
		<div class="col-md-4 transpdark align-self-center text-center h-100">
            <div class="d-md-flex align-items-center justify-content-center h-100">
                <h2 class="d-md-block align-self-center py-1 font-weight-light">Explore <span class="d-none d-md-inline">→</span></h2>
            </div>
		</div>
		<div class="col-md-8 p-5 align-self-center text-center">
            
            
                
                    <a class="mt-1 mb-1" href="https://wanted2.github.io/categories#Site-Reliable-Engineering">Site Reliable Engineering (13)</a>
                
                    <a class="mt-1 mb-1" href="https://wanted2.github.io/categories#Software-Engineering">Software Engineering (37)</a>
                
                    <a class="mt-1 mb-1" href="https://wanted2.github.io/categories#Computer-Vision">Computer Vision (6)</a>
                
                    <a class="mt-1 mb-1" href="https://wanted2.github.io/categories#Artificial-Intelligence">Artificial Intelligence (17)</a>
                
                    <a class="mt-1 mb-1" href="https://wanted2.github.io/categories#Tiếng-Việt,-日本語">Tiếng Việt, 日本語 (35)</a>
                
                    <a class="mt-1 mb-1" href="https://wanted2.github.io/categories#Project-Management">Project Management (34)</a>
                
            
            
		</div>
	</div>
</div>

<!-- Begin Footer
================================================== -->
<footer class="footer">
    <div class="container">
        <div class="row">
            <div class="col-md-6 col-sm-6 text-center text-lg-left">
                Copyright © 2022 AiFi 
            </div>
            <div class="col-md-6 col-sm-6 text-center text-lg-right">    
                <a target="_blank" href="https://www.wowthemes.net/mediumish-free-jekyll-template/">Mediumish Jekyll Theme</a> by WowThemes.net
            </div>
        </div>
    </div>
</footer>
<!-- End Footer
================================================== -->

</div> <!-- /.site-content -->

<!-- Scripts
================================================== -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>

<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>

<script src="https://wanted2.github.io/assets/js/mediumish.js"></script>


<script src="https://wanted2.github.io/assets/js/lazyload.js"></script>


<script src="https://wanted2.github.io/assets/js/ie10-viewport-bug-workaround.js"></script> 


<script id="dsq-count-scr" src="//caineng.disqus.com/count.js"></script>


</body>
</html>
