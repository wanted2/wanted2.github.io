<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<link rel="icon" href="https://wanted2.github.io/assets/images/favicon.ico">

<title>Implementing a complex system in AWS Lambda: Should or shouldn't? | AiFi</title>


  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-2CDTCF0EP6" crossorigin="anonymous"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-2CDTCF0EP6');
  </script>


<!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Implementing a complex system in AWS Lambda: Should or shouldn’t? | AiFi</title>
<meta name="generator" content="Jekyll v4.2.1" />
<meta property="og:title" content="Implementing a complex system in AWS Lambda: Should or shouldn’t?" />
<meta name="author" content="tuan" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Amazon Web Services Lambda [1] is a convenient serverless building block, can have hidden power. Surprisingly, it seems like that there is no official document explaining what should be a good Lambda function for a programming language. The size of an uncompressed Lambda function does not exceed 5 megabytes, and the size for all custom Lambda layers should not exceed 250 megabytes. Furthermore, parallelism can be limited with some supports to AVX2 [2] and multiprocessing [3]. Although anything can be implemented in Lambda, should we try to put a cumbersome architecture on it? It is an open question, and this post is to explore a possible answer." />
<meta property="og:description" content="Amazon Web Services Lambda [1] is a convenient serverless building block, can have hidden power. Surprisingly, it seems like that there is no official document explaining what should be a good Lambda function for a programming language. The size of an uncompressed Lambda function does not exceed 5 megabytes, and the size for all custom Lambda layers should not exceed 250 megabytes. Furthermore, parallelism can be limited with some supports to AVX2 [2] and multiprocessing [3]. Although anything can be implemented in Lambda, should we try to put a cumbersome architecture on it? It is an open question, and this post is to explore a possible answer." />
<meta property="og:site_name" content="AiFi" />
<meta property="og:image" content="/https://wanted2.github.io/assets/images/mxnet.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-04-03T00:00:00+09:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="/https://wanted2.github.io/assets/images/mxnet.png" />
<meta property="twitter:title" content="Implementing a complex system in AWS Lambda: Should or shouldn’t?" />
<script type="application/ld+json">
{"description":"Amazon Web Services Lambda [1] is a convenient serverless building block, can have hidden power. Surprisingly, it seems like that there is no official document explaining what should be a good Lambda function for a programming language. The size of an uncompressed Lambda function does not exceed 5 megabytes, and the size for all custom Lambda layers should not exceed 250 megabytes. Furthermore, parallelism can be limited with some supports to AVX2 [2] and multiprocessing [3]. Although anything can be implemented in Lambda, should we try to put a cumbersome architecture on it? It is an open question, and this post is to explore a possible answer.","image":"/https://wanted2.github.io/assets/images/mxnet.png","headline":"Implementing a complex system in AWS Lambda: Should or shouldn’t?","dateModified":"2021-04-03T00:00:00+09:00","datePublished":"2021-04-03T00:00:00+09:00","mainEntityOfPage":{"@type":"WebPage","@id":"/https://wanted2.github.io/aws-lambda-spacy-mxnet-possible-but-shouldnt/"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"/https://wanted2.github.io/assets/images/favicon.ico"},"name":"tuan"},"url":"/https://wanted2.github.io/aws-lambda-spacy-mxnet-possible-but-shouldnt/","author":{"@type":"Person","name":"tuan"},"@type":"BlogPosting","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    
<link href="https://wanted2.github.io/assets/css/screen.css" rel="stylesheet">

<link href="https://wanted2.github.io/assets/css/main.css" rel="stylesheet">

<script src="https://wanted2.github.io/assets/js/jquery.min.js"></script>
<script src="https://kit.fontawesome.com/d0b91d895e.js" crossorigin="anonymous"></script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        processEscapes: true
    }
    });
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript" crossorigin="anonymous"></script>
<script src="https://d3js.org/d3.v4.js" crossorigin="anonymous"></script>
<script src="https://bl.ocks.org/mbostock/raw/4061502/0a200ddf998aa75dfdb1ff32e16b680a15e5cb01/box.js" crossorigin="anonymous"></script>
</head>


<body class="layout-post">
	<!-- defer loading of font and font awesome -->
	<noscript id="deferred-styles">
		<link href="https://fonts.googleapis.com/css?family=Righteous%7CMerriweather:300,300i,400,400i,700,700i" rel="stylesheet">
		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
	</noscript>


<!-- Begin Menu Navigation
================================================== -->
<nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top mediumnavigation nav-down">

    <div class="container pr-0">

    <!-- Begin Logo -->
    <a class="navbar-brand" href="https://wanted2.github.io/">
    <img src="https://wanted2.github.io/assets/images/favicon.ico" alt="AiFi">
    </a>
    <!-- End Logo -->

    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarMediumish" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarMediumish">

        <!-- Begin Menu -->

            <ul class="navbar-nav ml-auto">

                
                <li class="nav-item">
                
                <a class="nav-link" href="https://wanted2.github.io/">Blog</a>
                </li>

                <li class="nav-item">
                <a class="nav-link" href="https://wanted2.github.io/about">About</a>
                </li>

                <li class="nav-item">
                <a class="nav-link" href="https://wanted2.github.io/projects">Projects</a>
                </li>

                <!-- <li class="nav-item">
                <a target="_blank" class="nav-link" href="https://bootstrapstarter.com/bootstrap-templates/template-mediumish-bootstrap-jekyll/"> Docs</a>
                </li>

                <li class="nav-item">
                <a target="_blank" class="nav-link" href="https://www.wowthemes.net/themes/mediumish-wordpress/"><i class="fab fa-wordpress-simple"></i> WP Version</a>
                </li>

                <li class="nav-item">
                <a target="_blank" class="nav-link" href="https://www.wowthemes.net/themes/mediumish-ghost/"><i class="fab fa-snapchat-ghost"></i> Ghost Version</a>
                </li>

                <li class="nav-item">
                <a target="_blank" class="nav-link" href="https://github.com/wowthemesnet/mediumish-theme-jekyll"><i class="fab fa-github"></i> Fork on Github</a>
                </li> -->

                <script src="https://wanted2.github.io/assets/js/lunr.js"></script>


<style>
    .lunrsearchresult .title {color: #d9230f;}
    .lunrsearchresult .url {color: silver;}
    .lunrsearchresult a {display: block; color: #777;}
    .lunrsearchresult a:hover, .lunrsearchresult a:focus {text-decoration: none;}
    .lunrsearchresult a:hover .title {text-decoration: underline;}
</style>


<form class="bd-search" onSubmit="return lunr_search(document.getElementById('lunrsearch').value);">
    <input type="text" class="form-control text-small launch-modal-search" id="lunrsearch" name="q" maxlength="255" value="" placeholder="Type and enter..."/>
</form>

<div id="lunrsearchresults">
    <ul></ul>
</div>

<script src="https://wanted2.github.io/assets/js/lunrsearchengine.js"></script>

            </ul>

        <!-- End Menu -->

    </div>

    </div>
</nav>
<!-- End Navigation
================================================== -->

<div class="site-content">

<div class="container">

<!-- Site Title
================================================== -->
<div class="mainheading">
    <h1 class="sitetitle">AiFi</h1>
    <p class="lead">
        An AI Engineer's blog
    </p>
</div>

<!-- Content
================================================== -->
<div class="main-content">
    <!-- Begin Article
================================================== -->
<div class="container">
    <div class="row">

        <!-- Post Share -->
        <div class="col-md-2 pl-0">
            <div class="share sticky-top sticky-top-offset">
    <p>
        Share
    </p>
    <ul>
        <li class="ml-1 mr-1">
            <a target="_blank" href="https://twitter.com/intent/tweet?text=Implementing a complex system in AWS Lambda: Should or shouldn't?&url=/https://wanted2.github.io/aws-lambda-spacy-mxnet-possible-but-shouldnt/" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                <i class="fab fa-twitter"></i>
            </a>
        </li>

        <li class="ml-1 mr-1">
            <a target="_blank" href="https://facebook.com/sharer.php?u=/https://wanted2.github.io/aws-lambda-spacy-mxnet-possible-but-shouldnt/" onclick="window.open(this.href, 'facebook-share', 'width=550,height=435');return false;">
                <i class="fab fa-facebook-f"></i>
            </a>
        </li>

        <li class="ml-1 mr-1">
            <a target="_blank" href="https://www.linkedin.com/shareArticle?mini=true&url=/https://wanted2.github.io/aws-lambda-spacy-mxnet-possible-but-shouldnt/" onclick="window.open(this.href, 'width=550,height=435');return false;">
                <i class="fab fa-linkedin-in"></i>
            </a>
        </li>

    </ul>
    
    <div class="sep">
    </div>
    <ul>
        <li>
        <a class="small smoothscroll" href="#disqus_thread"></a>
        </li>
    </ul>
    
</div>

        </div>

        <!-- Post -->
        

        <div class="col-md-9 flex-first flex-md-unordered">
            <div class="mainheading">

                <!-- Author Box -->
                
                <div class="row post-top-meta">
                    <div class="col-xs-12 col-md-1 col-lg-1 text-center mb-4 mb-md-0">
                        
                        <img class="author-thumb" src="https://wanted2.github.io/assets/images/favicon.png" alt="AiFi">
                        
                    </div>
                    <div class="col-xs-12 col-md-11 col-lg-11 text-md-left">
                        <a target="_blank" class="link-dark" href="">AiFi</a><a target="_blank" href="" class="btn follow">Follow</a>
                        <span class="author-description"></span>
                    </div>
                </div>
                

                <!-- Post Title -->
                <h1 class="posttitle">Implementing a complex system in AWS Lambda: Should or shouldn't?</h1>

            </div>

            <!-- Adsense if enabled from _config.yml (change your pub id and slot) -->
            
            <!-- End Adsense -->

            <!-- Post Featured Image -->
            

            
            <img class="featured-image img-fluid lazyimg" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAMAAAACCAQAAAA3fa6RAAAADklEQVR42mNkAANGCAUAACMAA2w/AMgAAAAASUVORK5CYII=" data-src="https://wanted2.github.io/assets/images/mxnet.png" alt="Implementing a complex system in AWS Lambda: Should or shouldn't?">
            

            
            <!-- End Featured Image -->

            <!-- Post Content -->
            <div class="article-post">
                <!-- Toc if any -->
                
                    
                    <div class="toc mt-4 mb-4 lead">
                        <h3 class="font-weight-bold">Summary</h3>
                        <ul>
  <li><a href="#introduction">Introduction</a>
    <ul>
      <li><a href="#purpose-finding-a-new-design">Purpose: Finding a new design</a></li>
      <li><a href="#setting-up-a-script">Setting up a script</a></li>
    </ul>
  </li>
  <li><a href="#implementations">Implementations</a>
    <ul>
      <li><a href="#ner-in-lambda">NER in Lambda</a>
        <ul>
          <li><a href="#the-handler">The handler</a></li>
          <li><a href="#custom-lambda-layers">Custom Lambda Layers</a></li>
        </ul>
      </li>
      <li><a href="#qa-in-lambda">QA in Lambda</a>
        <ul>
          <li><a href="#task-qa">Task QA</a></li>
          <li><a href="#the-handler-1">The handler</a></li>
          <li><a href="#custom-lambda-layer">Custom Lambda Layer</a></li>
        </ul>
      </li>
      <li><a href="#sam-template">SAM template</a></li>
    </ul>
  </li>
  <li><a href="#discussion">Discussion</a>
    <ul>
      <li><a href="#runtime">Runtime</a></li>
      <li><a href="#memory">Memory</a></li>
    </ul>
  </li>
  <li><a href="#conclusion">Conclusion</a></li>
  <li><a href="#reference">Reference</a></li>
</ul>
                    </div>
                
                <!-- End Toc -->
                <p>Amazon Web Services Lambda [1] is a convenient serverless building block, can have hidden power.
Surprisingly, it seems like that there is no official document explaining what should be a good Lambda function for a programming language.
The size of an uncompressed Lambda function does not exceed 5 megabytes, and the size for all custom Lambda layers should not exceed 250 megabytes.
Furthermore, parallelism can be limited with some supports to AVX2 [2] and multiprocessing [3].
Although anything can be implemented in Lambda, should we try to put a <code class="language-plaintext highlighter-rouge">cumbersome</code> architecture on it?
It is an open question, and this post is to explore a possible answer.
<!--more--></p>

<h2 id="introduction">Introduction</h2>

<h3 id="purpose-finding-a-new-design">Purpose: Finding a new design</h3>

<p>Managed services like Amazon Sagemaker [4] provides a consistent and powerful platform to train and deploy machine learning models.
Another managed service is AWS Lambda [1] can serve as the integration to API Gateway, which handles and responds to requests upon connections to other services.
It seems that it is a natural way to put a simplistic function in Lambda’s handler bodies.
But it also seems like there is no such enforcement for the complexity of the bodies.
In other words, we can put anything in them and pay-as-we-go.</p>

<p>Then, (training ML models can take time, and we do not put them in AWS), but can we put a cumbersome ML inference system in Lambda and serving requests?
In other words, we have 2 different usages for Lambda:</p>

<ul>
  <li><strong>Design 1</strong>: using Lambda as a <code class="language-plaintext highlighter-rouge">reception</code> and call SageMaker or Textract, Comprehend for inference.</li>
  <li><strong>Design 2</strong>: using Lambda custom layers to put the whole ML inference system in it and don’t call to other services for inference. The inference is in Lambda only.</li>
</ul>

<p>Then we knew that Design 1 is usual.
Is Design 2 a recommended way?</p>

<h3 id="setting-up-a-script">Setting up a script</h3>

<p>We already had a purpose, and we need a script to implement.
The script is simplistic: we choose a cumbersome system in a machine learning task, deploy it to AWS Lambda and measure the gain.</p>

<p><strong>The ML tasks</strong> are Named Entity Recognition (NER, [5,6]) and Context-based Question Answering (QA).
We choose them because they are complex enough and pre-trained models are ready.
NER is a problem in information extraction that looks at identifying atomic elements (entities) in text and classifying them into predefined classes such as person names, organizations, locations, dates, .etc.
Approaches can be using lexicons, sliding windows, and sequential models (Hidden Markov Models and Conditional Random Fields).
The input text is segmented into pieces of words (<code class="language-plaintext highlighter-rouge">tokens</code>), then a custom model classifies these token into predefined classes.
Tokenizers can be whitespace-based tokenizers or a language-independent data-driven approach like SentencePiece [7,8,9].
SentencePiece [7] implements subword regularization [8, 9].
Context-based Question Answering is the task of answering a question based on a context text.
The answer must be a part of the context.
Therefore, the answer can be returned as <code class="language-plaintext highlighter-rouge">[start_position, length]</code>.
A typical benchmark is the Standford SquAD dataset [10].
However, we don’t train models but do use state-of-the-art model ALBERT [11] for inference.</p>

<p><strong>The cumbersome systems/models</strong> are spaCy [12] and mxnet [13,14] based BERT models [11,15,16].
spaCy is a ready-to-use Python library for linguistics tasks like NER, PoS tagging.
Pipelines are units in spaCy to chain several different components such as tokenizers, ner, pos taggers, .etc.
Apache mxnet is a flexible and efficient library for Deep Learning.
Hence, the size of each library is about 250 megabytes.
Because the total size is about 500 megabytes, we need to separate it into 2 Lambdas.</p>

<p><strong>Serverless Architecture Model (SAM, [17])</strong> is used to deploy to Lambda.
We test and measure, monitor the gain directly in the AWS Lambda Web interface.</p>

<h2 id="implementations">Implementations</h2>

<h3 id="ner-in-lambda">NER in Lambda</h3>

<h4 id="the-handler">The handler</h4>
<p>We run a spaCy pipeline in Lambda to respond to a batch of sentences.
Pipelines in spaCy are reliable and stable processing units.
The default pipeline is as follows:</p>

<p><img src="https://spacy.io/pipeline-fde48da9b43661abcdf62ab70a546d71.svg" alt="" />
<em>Figure 1. spaCy’s default pipeline (source: <a href="https://spacy.io/usage/processing-pipelines">spaCy</a>)</em></p>

<p>Besides the entity information, it also returns PoS tags in the output <code class="language-plaintext highlighter-rouge">Doc</code>.
We can use the pipeline in Python:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">spacy</span>

<span class="c1"># Load default pipeline for linguistic task
</span><span class="n">nlp</span> <span class="o">=</span> <span class="n">spacy</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="s">'en_core_web_sm'</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>And the handler function is:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
</pre></td><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    <span class="s">"""Lambda function to process linguistic tasks

    Parameters
    ----------
    event: dict, required
        API Gateway Lambda Proxy Input Format

        Event doc: https://docs.aws.amazon.com/apigateway/latest/developerguide/set-up-lambda-proxy-integrations.html#api-gateway-simple-proxy-for-lambda-input-format

    context: object, required
        Lambda Context runtime methods and attributes

        Context doc: https://docs.aws.amazon.com/lambda/latest/dg/python-context-object.html

    Returns
    ------
    API Gateway Lambda Proxy Output Format: dict

        Return doc: https://docs.aws.amazon.com/apigateway/latest/developerguide/set-up-lambda-proxy-integrations.html
    """</span>

    <span class="k">assert</span> <span class="s">"body"</span> <span class="ow">in</span> <span class="n">event</span><span class="p">,</span> <span class="s">"Event is not coming from API Gateway"</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="s">"body"</span><span class="p">])</span>
    <span class="k">except</span> <span class="n">json</span><span class="p">.</span><span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">respond</span><span class="p">(</span><span class="nb">Exception</span><span class="p">(</span><span class="s">"JSON data problem"</span><span class="p">),</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">BaseException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">respond</span><span class="p">(</span><span class="nb">Exception</span><span class="p">(</span><span class="s">"JSON data problem"</span><span class="p">),</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">batch_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">'batch'</span><span class="p">]</span>
    <span class="k">except</span> <span class="nb">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">respond</span><span class="p">(</span><span class="nb">Exception</span><span class="p">(</span><span class="s">"You must submit a batch data"</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch_data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">respond</span><span class="p">(</span><span class="nb">Exception</span><span class="p">(</span><span class="s">"Batch data must be a list"</span><span class="p">),</span> <span class="bp">None</span><span class="p">)</span>
    <span class="n">nb</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch_data</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nb</span> <span class="o">&lt;</span> <span class="mi">100</span> <span class="ow">or</span> <span class="n">nb</span> <span class="o">&gt;</span> <span class="mi">300</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">respond</span><span class="p">(</span><span class="nb">Exception</span><span class="p">(</span><span class="s">"Batch size should be between 100 and 300 for trade-off between efficiency and waiting time"</span><span class="p">),</span> <span class="bp">None</span><span class="p">)</span>
    <span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Processing a batch of {} sentences"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">nb</span><span class="p">))</span>
    <span class="n">docs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">failed_sentences</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">sentence</span> <span class="ow">in</span> <span class="n">batch_data</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">doc</span> <span class="o">=</span> <span class="n">nlp</span><span class="p">(</span><span class="n">sentence</span><span class="p">)</span>
            <span class="n">docs</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">doc</span><span class="p">.</span><span class="n">to_json</span><span class="p">())</span>
        <span class="k">except</span> <span class="nb">BaseException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">failed_sentences</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">sentence</span><span class="p">)</span>
            <span class="k">continue</span>
    <span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="n">failed_sentences</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">respond</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="p">{</span>
        <span class="s">"success_sentences"</span><span class="p">:</span> <span class="n">docs</span><span class="p">,</span>
        <span class="s">"failed_sentences"</span><span class="p">:</span> <span class="n">failed_sentences</span>
    <span class="p">})</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>We remark the economy of Lambda business.
Concurrency [18] can provide up to 10000 Lambda processes running at a time, and Amazon makes money by charging on this use by requests and by GB-seconds.
Each time a concurrent Lambda runs, the bootstrap runs again.
For example, the line <code class="language-plaintext highlighter-rouge">nlp = spacy.load('en_core_web_sm')</code> runs every time invoking a concurrent Lambda.
Therefore, using a large batch size, we gain the time of reloading the <code class="language-plaintext highlighter-rouge">nlp</code> indeed.
However, a too large batch size (over 300 sentences) can lead to long service time.
It reduces the quality of the service and user experiences.
We choose a batch size between 100 and 300.</p>

<h4 id="custom-lambda-layers">Custom Lambda Layers</h4>

<p>spaCy is not installed in AWS Lambda runtime environments.
Therefore, we need to add a custom Lambda layer with the spaCy library.
Currently, AWS Lamda runtime uses <code class="language-plaintext highlighter-rouge">python3.7</code>.
We must use Docker to build spaCy in an Amazon Linux container and zip the <code class="language-plaintext highlighter-rouge">site-packages</code> folder.
A sample Dockerfile:</p>

<div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td><td class="rouge-code"><pre><span class="k">FROM</span><span class="s"> amazonlinux:2.0.20210219.0</span>

<span class="k">RUN </span>yum update <span class="nt">-y</span>
<span class="k">RUN </span>yum <span class="nb">install</span> <span class="nt">-y</span> python3-devel python3-setuptools python3-wheel git gcc gcc-c++ libatlas-devel
<span class="k">RUN </span><span class="nb">mkdir</span> <span class="nt">-p</span> /packages/python/lib/python3.7/site-packages
<span class="k">RUN </span>pip3 <span class="nb">install</span> <span class="nt">-U</span> numpy Cython
<span class="k">RUN </span>pip3 <span class="nb">install</span> <span class="nt">-U</span> numpy Cython <span class="nt">-t</span> /packages/python/lib/python3.7/site-packages
<span class="k">RUN </span>pip3 <span class="nb">install</span> <span class="nt">-U</span> cymem
<span class="k">RUN </span>pip3 <span class="nb">install</span> <span class="nt">-U</span> cymem <span class="nt">-t</span> /packages/python/lib/python3.7/site-packages
<span class="k">RUN </span>pip3 <span class="nb">install</span> <span class="nt">-U</span> murmurhash preshed
<span class="k">RUN </span>pip3 <span class="nb">install</span> <span class="nt">-U</span> murmurhash preshed <span class="nt">-t</span> /packages/python/lib/python3.7/site-packages
<span class="k">RUN </span><span class="nv">BLIS_REALLY_COMPILE</span><span class="o">=</span>1 <span class="nv">BLIS_ARCH</span><span class="o">=</span>generic pip3 <span class="nb">install</span> <span class="nt">-U</span> blis
<span class="k">RUN </span><span class="nv">BLIS_REALLY_COMPILE</span><span class="o">=</span>1 <span class="nv">BLIS_ARCH</span><span class="o">=</span>generic pip3 <span class="nb">install</span> <span class="nt">-U</span> blis <span class="nt">-t</span> /packages/python/lib/python3.7/site-packages
<span class="k">RUN </span>pip3 <span class="nb">install</span> <span class="nt">-U</span> thinc
<span class="k">RUN </span>pip3 <span class="nb">install</span> <span class="nt">-U</span> thinc <span class="nt">-t</span> /packages/python/lib/python3.7/site-packages
<span class="k">RUN </span>pip3 <span class="nb">install</span> <span class="nt">-U</span> spacy
<span class="k">RUN </span>pip3 <span class="nb">install</span> <span class="nt">-U</span> spacy <span class="nt">-t</span> /packages/python/lib/python3.7/site-packages
<span class="k">RUN </span>python3 <span class="nt">-m</span> spacy download en_core_web_sm
<span class="k">RUN </span>python3 <span class="nt">-m</span> spacy download ja_core_news_sm
<span class="k">RUN </span>pip3 <span class="nb">install </span>https://github.com/explosion/spacy-models/releases/download/en_core_web_sm-3.0.0/en_core_web_sm-3.0.0.tar.gz <span class="nt">-t</span> /packages/python/lib/python3.7/site-packages/
<span class="k">RUN </span><span class="nb">mkdir</span> <span class="nt">-p</span> /packages2/python/lib/python3.7/site-packages
<span class="k">RUN </span>pip3 <span class="nb">install </span>https://github.com/explosion/spacy-models/releases/download/ja_core_news_sm-3.0.0/ja_core_news_sm-3.0.0.tar.gz <span class="nt">-t</span> /packages2/python/lib/python3.7/site-packages/

<span class="k">WORKDIR</span><span class="s"> /packages</span>
<span class="k">RUN </span>zip <span class="nt">-r</span> spacy-py37.zip python

<span class="k">WORKDIR</span><span class="s"> /packages2</span>
<span class="k">RUN </span>zip <span class="nt">-r</span> spacy-ja-py37.zip python
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Note, only <code class="language-plaintext highlighter-rouge">spacy-py37.zip</code> has nearly 250 megabytes when uncompressed.</p>

<h3 id="qa-in-lambda">QA in Lambda</h3>

<h4 id="task-qa">Task QA</h4>
<p>Given the context, the machine looks for a part of the given context which answers the question.
A sample triplet is as follows:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>Context:
The Norman dynasty had a major political, cultural and military impact on medieval Europe and even the Near East. The Normans were famed for their martial spirit and eventually for their Christian piety, becoming exponents of the Catholic orthodoxy into which they assimilated. They adopted the Gallo-Romance language of the Frankish land they settled, their dialect becoming known as Norman, Normaund or Norman French, an important literary language. The Duchy of Normandy, which they formed by treaty with the French crown, was a great fief of medieval France, and under Richard I of Normandy was forged into a cohesive and formidable principality in feudal tenure. The Normans are noted both for their culture, such as their unique Romanesque architecture and musical traditions, and for their significant military accomplishments and innovations. Norman adventurers founded the Kingdom of Sicily under Roger II after conquering southern Italy on the Saracens and Byzantines, and an expedition on behalf of their duke, William the Conqueror, led to the Norman conquest of England at the Battle of Hastings in 1066. Norman cultural and military influence spread from these new European centres to the Crusader states of the Near East, where their prince Bohemond I founded the Principality of Antioch in the Levant, to Scotland and Wales in Great Britain, to Ireland, and to the coasts of north Africa and the Canary Islands.

Question: Who was the duke in the battle of Hastings?
Answer: William the Conqueror
</pre></td></tr></tbody></table></code></pre></div></div>
<h4 id="the-handler-1">The handler</h4>
<p>We pay attention to the BERT Transformer architecture [15,16].
BERT representations have been trained in several pretext tasks [19].</p>

<p><img src="/assets/images/bert.svg" alt="" />
<em>Figure 2. BERT architecture</em></p>

<p>The input of BERT models is a pair of <code class="language-plaintext highlighter-rouge">(question, context)</code> with a series of 0s and 1s representing the token types(question or context?), and the output is a triplet $(S,E,A)$.
We formulate the probability of finding a triplet output given the contextual embedding as
\(P(S, E, A | C) = P(S | C)\times P(E | S,C)\times P(A | C)\)
where $C$ is the contextual embedding vector, $S$ is the start position of the answer in the context, $E$ is the end position, and $A$ is the answerable decision to the question.
In the inference, $P(S|C)$ is modeled as the log-softmax of contextual embedding logits.
$P(E|S,C)$ is the log-softmax of concatenated features between contextual embeddings and start features.
$P(A|C)$ is computed using a feed-forward neural network and log-softmax.
The beam search is then applied in the computed score $P(S,E,A|C)$ to find the best candidates for an answer.
ALBERT [11] is a lightweight successor of BERT.
The inference code is almost similar.</p>

<h4 id="custom-lambda-layer">Custom Lambda Layer</h4>

<p>While mxnet library itself is small and takes nearly 250 megabytes, adding Gluon-NLP makes the size is over the limit.
Therefore, while building mxnet in a custom layer, we put <code class="language-plaintext highlighter-rouge">gluon-nlp</code> code into a Lambda function.</p>

<h3 id="sam-template">SAM template</h3>

<p>The template for the Lambdas can be found at <a href="https://github.com/wanted2/aws-sam-spacy-mxnet-bert-puppy-talk-example">https://github.com/wanted2/aws-sam-spacy-mxnet-bert-puppy-talk-example</a>.</p>

<h2 id="discussion">Discussion</h2>

<h3 id="runtime">Runtime</h3>
<p>We tested in Lambda and observed that</p>

<ul>
  <li>
    <p><strong>Spacy function</strong>: for a batch of 100 sentences, it took 5.7 seconds. For a batch of 500 sentences, it took 28.7 seconds. Therefore, we set the timeout to 30 seconds and recommend users to send batches with less than 300 items.</p>
  </li>
  <li>
    <p><strong>Multiprocessing</strong>:
There is a good guideline about multiprocessing in AWS Lambda:
https://aws.amazon.com/jp/blogs/compute/parallel-processing-in-python-with-aws-lambda/
I created the code (following the above article) to see if multiprocessing can help.
<strong>Unfortunately, multiprocessing does not help ;)</strong>
For a batch of 100 sentences, it took 15.5s, 3x slower than sequential processing.</p>
  </li>
</ul>

<h3 id="memory">Memory</h3>
<p>A memory budget 256MB was enough for spaCy.
The budget for mxnet inference is 4GB.</p>

<h2 id="conclusion">Conclusion</h2>

<p>Some lessons we learned from this implementation:</p>

<ul>
  <li><strong>Simplicity is the best design</strong>: adding custom Lambda layers requires going through the hurdle of building too many unexpected things such as custom library distributions for specific architecture and operating systems (amazon linux), adjusting the size to match the policy of Lambda, .etc.</li>
  <li><strong>Don’t think you can do whatever you want with Lambda</strong>. By bypassing the size restrictions of Lambda code, indeed, we are <code class="language-plaintext highlighter-rouge">hacking</code> AWS in some senses. Then this is a bad design! The company made the restriction and the design of Lambda to protect their business models (maybe), and we are hacking them for more performance! :D That’s the whole picture of what we were doing.</li>
  <li><strong>Design 2 is for hackers, then Design 1 is for usual developers</strong>.</li>
</ul>

<p>In this post, we only considered two designs with all components are in the AWS Cloud.
In practice, the systems may have components not in the cloud, and that makes the game is far interesting.</p>

<h2 id="reference">Reference</h2>

<ol class="bibliography"><li><span id="AWSLambd88:online"><i>AWS Lambda – Serverless Compute - Amazon Web Services</i>. https://aws.amazon.com/lambda/.</span></li>
<li><span id="Creating27:online"><i>Creating faster AWS Lambda functions with AVX2 | AWS Compute Blog</i>. https://aws.amazon.com/blogs/compute/creating-faster-aws-lambda-functions-with-avx2/.</span></li>
<li><span id="Parallel52:online"><i>Parallel Processing in Python with AWS Lambda | AWS Compute Blog</i>. https://aws.amazon.com/blogs/compute/parallel-processing-in-python-with-aws-lambda/.</span></li>
<li><span id="AmazonSa17:online"><i>Amazon SageMaker – Machine Learning – Amazon Web Services</i>. https://aws.amazon.com/sagemaker/.</span></li>
<li><span id="NamedEnt13:online"><i>Named Entity Recognition · Prodigy · An annotation tool for AI, Machine Learning &amp; NLP</i>. https://prodi.gy/docs/named-entity-recognition.</span></li>
<li><span id="NamedEnt0:online"><i>Named Entity Recognition - Cohen Courses</i>. http://curtis.ml.cmu.edu/w/courses/index.php/Named_Entity_Recognition.</span></li>
<li><span id="googlese65:online"><i>google/sentencepiece: Unsupervised text tokenizer for Neural Network-based text generation.</i> https://github.com/google/sentencepiece.</span></li>
<li><span id="sennrich-etal-2016-neural">Sennrich, R., Haddow, B., &amp; Birch, A. (2016). Neural Machine Translation of Rare Words with Subword Units. <i>Proceedings of the 54th Annual Meeting of the Association for Computational Linguistics (Volume 1: Long Papers)</i>, 1715–1725. https://doi.org/10.18653/v1/P16-1162</span></li>
<li><span id="DBLP:journals/corr/abs-1804-10959">Kudo, T. (2018). Subword Regularization: Improving Neural Network Translation Models
               with Multiple Subword Candidates. <i>CoRR</i>, <i>abs/1804.10959</i>. http://arxiv.org/abs/1804.10959</span></li>
<li><span id="TheStanf29:online"><i>The Stanford Question Answering Dataset</i>. https://rajpurkar.github.io/SQuAD-explorer/.</span></li>
<li><span id="DBLP:journals/corr/abs-1909-11942">Lan, Z., Chen, M., Goodman, S., Gimpel, K., Sharma, P., &amp; Soricut, R. (2019). ALBERT: A Lite BERT for Self-supervised Learning of Language
               Representations. <i>CoRR</i>, <i>abs/1909.11942</i>. http://arxiv.org/abs/1909.11942</span></li>
<li><span id="spaCyIn92:online"><i>spaCy: Industrial-strength Natural Language Processing in Python</i>. https://spacy.io/.</span></li>
<li><span id="ApacheMX35:online"><i>Apache MXNet on AWS</i>. https://aws.amazon.com/mxnet/.</span></li>
<li><span id="ApacheMX2:online"><i>Apache MXNet | A flexible and efficient library for deep learning.</i> https://mxnet.apache.org/versions/1.8.0/.</span></li>
<li><span id="DBLP:journals/corr/abs-1810-04805">Devlin, J., Chang, M.-W., Lee, K., &amp; Toutanova, K. (2018). BERT: Pre-training of Deep Bidirectional Transformers for Language
               Understanding. <i>CoRR</i>, <i>abs/1810.04805</i>. http://arxiv.org/abs/1810.04805</span></li>
<li><span id="GluonNLP52:online"><i>GluonNLP: NLP made easy — gluonnlp 0.10.0 documentation</i>. https://nlp.gluon.ai/index.html.</span></li>
<li><span id="Whatisth14:online"><i>What is the AWS Serverless Application Model (AWS SAM)? - AWS Serverless Application Model</i>. https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/what-is-sam.html.</span></li>
<li><span id="Managing69:online"><i>Managing concurrency for a Lambda function - AWS Lambda</i>. https://docs.aws.amazon.com/lambda/latest/dg/configuration-concurrency.html.</span></li>
<li><span id="SelfSupe2:online"><i>Self Supervised Representation Learning in NLP</i>. https://amitness.com/2020/05/self-supervised-learning-nlp/.</span></li></ol>

            </div>

            <!-- Rating -->
            

            <!-- Post Date -->
            <p>
            <small>
                <span class="post-date"><time class="post-date" datetime="2021-04-03">03 Apr 2021</time></span>           
                
                </small>
            </p>

            <!-- Post Categories -->
            <div class="after-post-cats">
                <ul class="tags mb-4">
                    
                    
                    <li>
                        <a class="smoothscroll" href="https://wanted2.github.io/categories#Artificial-Intelligence">Artificial Intelligence</a>
                    </li>
                    
                    <li>
                        <a class="smoothscroll" href="https://wanted2.github.io/categories#Site-Reliable-Engineering">Site Reliable Engineering</a>
                    </li>
                    
                </ul>
            </div>
            <!-- End Categories -->

            <!-- Post Tags -->
            <div class="after-post-tags">
                <ul class="tags">
                    
                    
                    <li>
                        <a class="smoothscroll" href="https://wanted2.github.io/tags#albert">#albert</a>
                    </li>
                    
                    <li>
                        <a class="smoothscroll" href="https://wanted2.github.io/tags#bert">#bert</a>
                    </li>
                    
                    <li>
                        <a class="smoothscroll" href="https://wanted2.github.io/tags#gluon">#gluon</a>
                    </li>
                    
                    <li>
                        <a class="smoothscroll" href="https://wanted2.github.io/tags#gluon-nlp">#gluon-nlp</a>
                    </li>
                    
                    <li>
                        <a class="smoothscroll" href="https://wanted2.github.io/tags#mxnet">#mxnet</a>
                    </li>
                    
                    <li>
                        <a class="smoothscroll" href="https://wanted2.github.io/tags#natural-language-processing">#natural language processing</a>
                    </li>
                    
                    <li>
                        <a class="smoothscroll" href="https://wanted2.github.io/tags#nlp">#nlp</a>
                    </li>
                    
                    <li>
                        <a class="smoothscroll" href="https://wanted2.github.io/tags#site-reliability-engineering">#site reliability engineering</a>
                    </li>
                    
                    <li>
                        <a class="smoothscroll" href="https://wanted2.github.io/tags#spacy">#spacy</a>
                    </li>
                    
                </ul>
            </div>
            <!-- End Tags -->

            <!-- Prev/Next -->
            <div class="row PageNavigation d-flex justify-content-between font-weight-bold">
            
            <a class="prev d-block col-md-6" href="https://wanted2.github.io//ban-ve-thiet-ke-he-thong-co-quan-ly-user-non-english/"> &laquo; Bàn về thiết kế hệ thống có quản lý users: Cây nhà lá vườn hay ăn sẵn?</a>
            
            
            <a class="next d-block col-md-6 text-lg-right" href="https://wanted2.github.io//chon-de-tai-nghien-cuu-non-english/">Làm thế nào chọn đề tài nghiên cứu phù hợp với lựa chọn nghề nghiệp trong ngành trí tuệ nhân tạo? &raquo; </a>
            
            <div class="clearfix"></div>
            </div>
            <!-- End Categories -->

        </div>
        <!-- End Post -->

    </div>
</div>
<!-- End Article
================================================== -->

<!-- Begin Comments
================================================== -->

    <div class="container">
        <div id="comments" class="row justify-content-center mb-5">
            <div class="col-md-8">
                <section class="disqus">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'caineng'; 
        var disqus_developer = 0;
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = window.location.protocol + '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>

            </div>
        </div>
    </div>

<!--End Comments
================================================== -->

<!-- Review with LD-JSON, adapt it for your needs if you like, but make sure you test the generated HTML source code first: 
https://search.google.com/structured-data/testing-tool/u/0/
================================================== -->

</div>


<!-- Bottom Alert Bar
================================================== -->
<div class="alertbar">
	<div class="container text-center">
		<span><img src="https://wanted2.github.io/assets/images/favicon.ico" alt="AiFi" style="max-height: 48px;" /> &nbsp; Never miss a <b>story</b> from us, subscribe to our newsletter</span>
        <form action="https://wowthemes.us11.list-manage.com/subscribe/post?u=8aeb20a530e124561927d3bd8&amp;id=8c3d2d214b" method="post" name="mc-embedded-subscribe-form" class="wj-contact-form validate" target="_blank" novalidate>
            <div class="mc-field-group">
            <input type="email" placeholder="Email" name="EMAIL" class="required email" id="mce-EMAIL" autocomplete="on" required>
            <input type="submit" value="Subscribe" name="subscribe" class="heart">
            </div>
        </form>
	</div>
</div>

    
</div>

<!-- Categories Jumbotron
================================================== -->
<div class="jumbotron fortags">
	<div class="d-md-flex h-100">
		<div class="col-md-4 transpdark align-self-center text-center h-100">
            <div class="d-md-flex align-items-center justify-content-center h-100">
                <h2 class="d-md-block align-self-center py-1 font-weight-light">Explore <span class="d-none d-md-inline">→</span></h2>
            </div>
		</div>
		<div class="col-md-8 p-5 align-self-center text-center">
            
            
                
                    <a class="mt-1 mb-1" href="https://wanted2.github.io/categories#Site-Reliable-Engineering">Site Reliable Engineering (13)</a>
                
                    <a class="mt-1 mb-1" href="https://wanted2.github.io/categories#Software-Engineering">Software Engineering (33)</a>
                
                    <a class="mt-1 mb-1" href="https://wanted2.github.io/categories#Computer-Vision">Computer Vision (5)</a>
                
                    <a class="mt-1 mb-1" href="https://wanted2.github.io/categories#Artificial-Intelligence">Artificial Intelligence (15)</a>
                
                    <a class="mt-1 mb-1" href="https://wanted2.github.io/categories#Tiếng-Việt,-日本語">Tiếng Việt, 日本語 (29)</a>
                
                    <a class="mt-1 mb-1" href="https://wanted2.github.io/categories#Project-Management">Project Management (31)</a>
                
            
            
		</div>
	</div>
</div>

<!-- Begin Footer
================================================== -->
<footer class="footer">
    <div class="container">
        <div class="row">
            <div class="col-md-6 col-sm-6 text-center text-lg-left">
                Copyright © 2021 AiFi 
            </div>
            <div class="col-md-6 col-sm-6 text-center text-lg-right">    
                <a target="_blank" href="https://www.wowthemes.net/mediumish-free-jekyll-template/">Mediumish Jekyll Theme</a> by WowThemes.net
            </div>
        </div>
    </div>
</footer>
<!-- End Footer
================================================== -->

</div> <!-- /.site-content -->

<!-- Scripts
================================================== -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>

<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>

<script src="https://wanted2.github.io/assets/js/mediumish.js"></script>


<script src="https://wanted2.github.io/assets/js/lazyload.js"></script>


<script src="https://wanted2.github.io/assets/js/ie10-viewport-bug-workaround.js"></script> 


<script id="dsq-count-scr" src="//caineng.disqus.com/count.js"></script>


</body>
</html>
